# 发货单财务字段后续优化计划

## 📋 背景说明

当前发货单表（`shipment_orders`）中包含了一些财务相关字段。根据系统架构原则，**发货单只应关注物流业务**，完整的财务核算应该在统一的财务系统中进行。

## ✅ 当前保留的物流成本字段（正确）

以下字段属于物流业务范畴，**应当保留**：

| 字段名 | 类型 | 说明 | 状态 |
|--------|------|------|------|
| `currency` | String | 币种 | ✅ 保留 |
| `freight_cost` | Decimal(18,2) | 运费 | ✅ 保留 |
| `insurance_cost` | Decimal(18,2) | 保险费 | ✅ 保留 |
| `handling_fee` | Decimal(18,2) | 操作费 | ✅ 保留 |
| `other_costs` | Decimal(18,2) | 其他物流费用 | ✅ 保留 |
| `total_logistics_cost` | Decimal(18,2) | 物流总成本 | ✅ 保留 |
| `freight_term` | String | 运费条款(prepaid/collect/third_party) | ✅ 保留 |

**理由**：这些是与发货物流直接相关的成本，记录在发货单中便于物流部门管理和对账。

## ⚠️ 向后兼容字段（逐步废弃）

以下字段为历史遗留，**保留但不推荐使用**：

| 字段名 | 类型 | 说明 | 建议处理 | 替代方案 |
|--------|------|------|----------|----------|
| `total_amount` | Decimal(18,2) | 总金额（不含税） | 标记@deprecated | 从采购明细计算 |
| `total_tax_amount` | Decimal(18,2) | 总税额 | 标记@deprecated | 从报关单获取 |
| `total_amount_with_tax` | Decimal(18,2) | 含税总金额 | 标记@deprecated | 从采购明细+报关单计算 |

**处理策略**：
- 在Model中添加注释标记为 `@deprecated`
- 前端显示时添加提示："仅供参考，实际金额以采购/财务系统为准"
- 新创建的发货单不强制填写这些字段
- 在v2.0版本中考虑移除

## ❌ 应移至财务系统的字段（待清理）

以下字段不应该在发货单中，**未来版本应移除**：

### 1. 货值相关
| 字段名 | 说明 | 应该去哪里 |
|--------|------|------------|
| `total_goods_value` | 货物总价值 | 从商品明细实时计算 |
| `declared_value` | 申报价值 | 从报关单获取 |

### 2. 采购成本相关
| 字段名 | 说明 | 应该去哪里 |
|--------|------|------------|
| `total_purchase_cost` | 采购总成本 | 从采购明细实时计算 |

### 3. 利润分析相关
| 字段名 | 说明 | 应该去哪里 |
|--------|------|------------|
| `profit_margin` | 利润率 | 财务系统动态计算 |
| `cost_allocation_method` | 成本分摊方式 | 财务配置表 |

### 4. 税务相关
| 字段名 | 说明 | 应该去哪里 |
|--------|------|------------|
| `vat_number` | VAT税号 | 公司/收货人主表 |
| `tax_rate` | 税率 | 税务配置表 |
| `estimated_tax` | 预估税费 | 税务计算结果表 |
| `actual_tax` | 实际税费 | 税务凭证表 |

## 📅 分阶段清理计划

### 阶段1：标记废弃（当前）
**时间**：v1.1（当前版本）
- ✅ 前端FinanceTab简化为"物流成本Tab"
- ✅ 只显示物流成本相关字段
- ✅ 移除利润率、采购成本、税务信息的显示
- ✅ 添加提示："完整财务核算请前往财务系统"

**代码标记**：
```python
# backend/app/models/logistics/shipment.py
class ShipmentOrder(db.Model):
    # ... 其他字段 ...
    
    # ===== 以下字段标记为废弃，将在v2.0移除 =====
    # @deprecated Use financial system instead
    profit_margin: Mapped[Optional[Decimal]] = mapped_column(
        DECIMAL(7, 2), 
        comment='利润率(%) - DEPRECATED: 请使用财务系统计算'
    )
    
    # @deprecated Calculate from purchase items
    total_purchase_cost: Mapped[Optional[Decimal]] = mapped_column(
        DECIMAL(18, 2), 
        comment='采购总成本 - DEPRECATED: 从采购明细计算'
    )
    # ... 其他废弃字段 ...
```

### 阶段2：数据迁移（v1.5）
**前提条件**：财务系统基本完善
- [ ] 创建 `fin_shipment_costs` 表或使用 `fin_payment_pool`
- [ ] 将现有物流成本数据迁移到财务系统
- [ ] 提供迁移脚本和回滚方案
- [ ] 前端调整为从财务API查询数据

**迁移脚本示例**：
```python
# backend/migrations/versions/xxx_migrate_shipment_costs.py
def upgrade():
    # 将发货单的物流成本迁移到财务系统
    op.execute("""
        INSERT INTO fin_payment_pool (
            amount, currency, type, status, 
            reference_type, reference_id, created_at
        )
        SELECT 
            freight_cost, currency, 'logistics_freight', 'paid',
            'shipment', id, created_at
        FROM shipment_orders
        WHERE freight_cost IS NOT NULL AND freight_cost > 0
    """)
```

### 阶段3：字段移除（v2.0）
**前提条件**：财务系统完善，所有业务已迁移
- [ ] 创建数据库迁移，删除废弃字段
- [ ] 更新Model定义
- [ ] 更新Schema定义
- [ ] 更新前端TypeScript接口
- [ ] 更新测试用例

**清理清单**：
```sql
-- 移除财务相关字段
ALTER TABLE shipment_orders 
DROP COLUMN IF EXISTS total_goods_value,
DROP COLUMN IF EXISTS declared_value,
DROP COLUMN IF EXISTS total_purchase_cost,
DROP COLUMN IF EXISTS profit_margin,
DROP COLUMN IF EXISTS cost_allocation_method,
DROP COLUMN IF EXISTS vat_number,
DROP COLUMN IF EXISTS tax_rate,
DROP COLUMN IF EXISTS estimated_tax,
DROP COLUMN IF EXISTS actual_tax;
```

## 🎯 最终目标架构

### 发货单表（`shipment_orders`）
**职责**：物流业务信息
```
✅ 仓库信息（origin_warehouse_*, destination_warehouse_*）
✅ 物流商信息（logistics_provider, tracking_no）
✅ 运输信息（shipping_method, freight_term）
✅ 时间节点（各种_date字段）
✅ 包装信息（total_packages, total_weight, total_volume）
✅ 物流成本（freight_cost, insurance_cost, handling_fee）
✅ FBA/第三方仓业务字段
```

### 财务系统
**职责**：完整财务核算
```
✅ 采购成本：从 shipment_purchase_items 汇总
✅ 物流成本：从 fin_payment_pool (type='logistics') 查询
✅ 关税：从 customs_declarations 获取
✅ 销售收入：从订单系统获取
✅ 利润分析：财务系统动态计算
✅ 成本分摊：财务规则引擎计算
```

### 前端显示
**物流成本Tab**：
```typescript
// 仅显示物流直接成本
<Statistic title="运费" :value="shipment.freight_cost" />
<Statistic title="保险费" :value="shipment.insurance_cost" />
<Statistic title="操作费" :value="shipment.handling_fee" />
```

**财务系统**（独立页面）：
```typescript
// 完整财务分析
const finance = await getShipmentFinanceAnalysis(shipmentId);
// finance.purchaseCost - 从采购明细
// finance.logisticsCost - 从物流成本
// finance.customsTax - 从报关单
// finance.revenue - 从订单
// finance.profit - 动态计算
```

## 📝 注意事项

1. **不要破坏现有数据**
   - 字段标记废弃但不立即删除
   - 提供充足的迁移时间
   - 保留数据快照

2. **前端显示调整**
   - 前端先调整显示逻辑
   - 后端字段后续再清理
   - 保持向后兼容

3. **与财务团队沟通**
   - 确认财务系统需求
   - 设计统一的数据接口
   - 制定迁移计划

4. **测试覆盖**
   - 每个阶段都要充分测试
   - 提供回滚方案
   - 监控数据一致性

## ✅ 当前状态总结

**阶段1已完成** ✅：
- ✅ 前端FinanceTab简化为"物流成本Tab"
- ✅ 只显示物流相关成本字段（运费、保险费、操作费等）
- ✅ 移除复杂财务计算和展示（利润率、税务等）
- ✅ 添加说明引导用户使用财务系统
- ✅ 后端Model字段添加 `[DEPRECATED]` 标记和注释
- ✅ 后端Schema字段添加 `[DEPRECATED]` 描述
- ✅ 前端TypeScript接口添加 `@deprecated` JSDoc注释

**下一步（阶段2 - 待财务模块成熟后）**：
- ⏳ 等待财务模块完善
- ⏳ 设计财务系统与发货单的接口
- ⏳ 制定详细的数据迁移方案
- ⏳ 创建 `fin_shipment_costs` 表或使用 `fin_payment_pool`

**长期目标（阶段3 - v2.0）**：
- 🎯 发货单只管物流业务
- 🎯 财务系统统一管理所有财务数据
- 🎯 数据源单一，不重复存储
- 🎯 移除废弃字段


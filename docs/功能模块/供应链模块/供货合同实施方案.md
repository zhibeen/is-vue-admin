# L1.5 供货合同 (Supply Contract) 开发实施方案

## 1. 概述与定位

### 1.1 背景
L1 交付合同 (Delivery Contract) 基于**物流视角**，记录的是 SKU 级别的明细（如“左前大灯”、“右前大灯”）。
但在**财务结算**和**税务开票**环节，必须转换为“票据视角”进行聚合（如统一为“汽车车灯总成”）。

这里涉及两套完全独立的税务体系：
1.  **出口退税 (Export Tax Refund)**: 基于 **HS Code**。这是国家政策，由产品属性决定。
2.  **进项增值税 (Purchase VAT)**: 基于 **供应商纳税人身份**。这是商业行为，由供应商决定（一般纳税人 vs 小规模纳税人）。

### 1.2 定位：L1.5 层 (The Bridge)
L1.5 供货合同 (FinSupplyContract) 负责将物流数据转换为财务票据数据，并作为“进项发票”的数字化底账。

- **上游**: L1 交付合同。
- **核心逻辑**: 
    - **品名**: 来源于产品报关品名 (Declared Name)。
    - **税率**: 来源于供应商默认税率 (Supplier VAT Rate)，而非产品本身。

---

## 2. 数据库模型设计 (Database Schema)

### 2.1 税收基础数据

#### A. HS编码库 (`SysHSCode`)
**文件**: `backend/app/models/serc/foundation.py` (已存在)
- `code`: HS Code
- `refund_rate`: **退税率** (核心字段，如 0.13)。

#### B. 税收分类字典表 (`SysTaxCategory`)
**文件**: `backend/app/models/product.py` (新增)
用于存储税务局的标准“税收分类编码”，主要用于开票合规。

| 字段名 | 类型 | 说明 | 示例 |
| :--- | :--- | :--- | :--- |
| `code` | String(50) | **税收分类编码** | "109010101" |
| `name` | String(200) | **税收分类名称** | "汽车配件" |
| `reference_vat_rate` | Decimal(5,4) | 参考税率 | 0.13 (仅供参考，不强制) |

### 2.2 供应商扩展 (`SysSupplier`)
**文件**: `backend/app/models/purchase/supplier.py` (修改)

| 字段名 | 类型 | 说明 | 示例 |
| :--- | :--- | :--- | :--- |
| `taxpayer_type` | String | 纳税人类型 | `general` (一般), `small` (小规模) |
| `default_vat_rate` | Decimal | **默认开票税率** | 0.13 或 0.03 |

### 2.3 产品档案扩展 (`SysProduct`)
**文件**: `backend/app/models/product.py` (修改)

| 字段名 | 类型 | 说明 | 逻辑 |
| :--- | :--- | :--- | :--- |
| `declared_name` | String(200) | **报关品名** | 退税依据 |
| `hs_code_id` | Integer | **HS Code** | 关联 SysHSCode -> 获取 `refund_rate` |
| `tax_category_id` | Integer | **税收分类** | 关联 SysTaxCategory -> 获取分类编码 |

> **关键点**: 产品表**不存**进项税率。进项税率在生成合同时根据供应商确定。

### 2.4 供货合同明细表 (`FinSupplyContractItem`)
**文件**: `backend/app/models/serc/finance.py`

| 字段名 | 类型 | 说明 | 取值逻辑 |
| :--- | :--- | :--- | :--- |
| `invoice_name` | String | 开票品名 | 默认取 `Product.declared_name` |
| `tax_rate` | Decimal | **实际税率** | 默认取 `Supplier.default_vat_rate` |
| `tax_code` | String | 税收分类编码 | 默认取 `Product.tax_category.code` |

---

## 3. 业务逻辑与算法 (Business Logic)

### 3.1 供货合同生成逻辑

**触发**: 人工触发（供应链交付 -> 编制结算书）。

**税务逻辑 (Tax Logic)**:

1.  **确定品名**: 取 `Product.declared_name` (若空则警告)。
2.  **确定税收编码**: 取 `Product.tax_category.code`。
3.  **确定税率 (优先级)**:
    - P1: `Supplier.default_vat_rate` (如果供应商有设定)
    - P2: `SysTaxCategory.reference_vat_rate` (如果供应商未设定)
    - P3: 系统默认 (0.13)

**示例场景**:
- 采购 "LED灯" (产品标准税率 13%)。
- **供应商 A** (一般纳税人): 系统自动匹配税率 **13%**。
- **供应商 B** (小规模纳税人): 系统自动匹配税率 **3%** (或 1%)。

此逻辑完美解决了“同一商品不同供应商税率不同”的问题。

### 3.2 聚合算法
- 按 `(invoice_name, invoice_unit, tax_rate, unit_price)` 进行分组聚合。
- 确保 `Total Amount` 与 L1 交付单完全一致。

---

## 4. 前端交互设计

### 4.1 供应商管理
- 新增字段: “纳税人类型”、“默认开票税率”。

### 4.2 产品管理
- 强调维护: **HS Code** (影响退税测算), **报关品名**, **税收分类**。

### 4.3 结算书编制器
- 在生成预览时，前端需展示:
    - **进项税率**: 可编辑。默认值源于供应商档案。
    - **退税率**: 只读展示 (源于 HS Code)，方便财务预估退税额。

---

## 5. 总结

通过将“进项税率”解耦至供应商维度，将“退税率”绑定至 HS Code 维度，系统能够真实反映贸易业务中的税务逻辑，避免了数据模型的僵化。

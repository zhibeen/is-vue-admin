# IS-Vue-Admin 产品编码系统 V2.0 设计方案 (修订版)

## 1. 概述

本方案旨在解决跨境电商/汽配行业复杂的产品编码需求，特别是 SKU 变体众多、编码规则不统一的问题。V2.0 方案引入了 **"双轨制编码体系"**，并支持基于分类的灵活继承与覆盖机制。

### 1.1 核心目标
1. **标准化**: 统一 SPU 和 SKU 的生成逻辑。
2. **可读性**: SPU特征码用于业务交流，直观反映产品属性。
3. **系统化**: SKU编码用于仓储物流，定长数字结构，便于扫码和系统处理。
4. **灵活性**: 支持汽配与非汽配类目的差异化配置。

---

## 2. 编码体系设计 (双轨制)

系统同时维护两套编码，服务于不同场景。

### 2.1 SPU 特征码 (SPU Feature Code)
*   **用途**: 逻辑标识，作为 SKU 的公共前缀，用于电商刊登、产品开发交流。
*   **结构**: 模板驱动，完全动态。
*   **示例**:
    *   汽配: `HL-CHE-SIL-07-13` (前大灯-雪佛兰-索罗德-07至13款)
    *   包含平台: `HL-BMW-3ER-E90-05-11` (前大灯-宝马-3系-E90平台-05至11款)
    *   通用: `WR-GEN-PRO` (扳手-通用品牌-专业系列)

### 2.2 SKU 编码 (SKU Code)
*   **用途**: WMS 仓储作业、条码打印、系统唯一键。
*   **特点**: **数字主码 + 字母后缀**。
*   **结构**: `[类目码(3位)]` + `[车型码(4位)]` + `[流水号(2位)]` + `[属性后缀(可选)]`
*   **总长度**: 9位数字 + 字母后缀。
*   **控制逻辑**: 仅当属性配置为 `include_in_code=True` 时，才生成字母后缀；否则通过流水号递增区分。

#### A. 组成详解

| 组成部分 | 长度 | 示例 | 说明 |
| :--- | :--- | :--- | :--- |
| **类目码** | 3位 | `101` | **Category Code**。系统内分类的唯一数字标识。 |
| **车型码** | 4位 | `0105` | **Vehicle Code**。由 Brand(2位) + Model(2位) 组成。<br>**注意**: 即使车型存在 Platform 层级，SKU 车型码依然只取 Brand + Model，不包含 Platform Code。 |
| **流水码** | 2位 | `01` | **Serial**。单产品变体计数。从 01 开始，至 99。<br>**自增规则**: 当存在 `include_in_code=False` 的变体属性（如颜色）差异时，流水号递增。当仅有 `include_in_code=True` 的属性（如位置）差异时，共享同一流水号。 |
| **属性后缀** | 变长 | `D` | **Attr Suffix**。仅 `include_in_code=True` 的属性生成。如位置 L/R。 |

#### B. 示例
*   **显式后缀 (位置)**: `101120501L` (流水01 + 左侧), `101120501R` (流水01 + 右侧)
*   **隐式变体 (颜色)**: `101120501` (黑色), `101120502` (电镀) - **无后缀，流水号自增**。

---

## 3. 车型编码表 (Vehicle Codes)

### 3.1 品牌编码 (Make Code - 前2位)

| 编码 | 品牌 (CN) | Brand (EN) | | 编码 | 品牌 (CN) | Brand (EN) |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **01** | 大众 | Volkswagen | | **15** | 本田 | Honda |
| **02** | 宝马 | BMW | | **16** | 三菱 | Mitsubishi |
| **03** | 奔驰 | Mercedes-Benz | | **17** | 大宇 | Daewoo |
| **04** | 福特 | Ford | | **18** | 吉普 | Jeep |
| **05** | 标志 | Peugeot | | **19** | 起亚 | Kia |
| **06** | 欧宝 | Opel | | **20** | 依维柯 | Iveco |
| **07** | 雷诺 | Renault | | **21** | 萨博 | Saab |
| **08** | 菲亚特 | Fiat | | **22** | 通用 | GM |
| **09** | 沃尔沃 | Volvo | | **23** | 路虎 | Land Rover |
| **10** | 马自达 | Mazda | | **24** | 雪佛兰 | Chevrolet |
| **11** | 尼桑 | Nissan | | **25** | 道奇 | Dodge |
| **12** | 丰田 | Toyota | | **26** | GMC | GMC |
| **13** | 铃木 | Suzuki | | **27** | 克莱斯勒 | Chrysler |
| **14** | 现代 | Hyundai | | **99** | 其他 | Others |

### 3.2 车型编码 (Model Code - 后2位)
*   **规则**: 每个品牌下的车型，按字母或热度排序，分配 `01` - `99`。
*   **小众车型**: 统一使用 `99`。
*   **示例**:
    *   Toyota Camry: `12` (Toyota) + `05` (Camry 假设码) = `1205`
    *   Toyota Corolla: `12` (Toyota) + `08` (Corolla 假设码) = `1208`

### 3.3 平台编码 (Platform Code - 可选)
*   **规则**: 仅存储在数据库中用于排序和 SPU 生成，**不参与 SKU 数字码**。
*   **示例**:
    *   BMW 3 Series E90: Code `03` (Model) -> `01` (E90)
    *   BMW 3 Series F30: Code `03` (Model) -> `02` (F30)

---

## 4. 数据库模型设计调整

### 4.1 类目表 (`categories`)
*   `code`: **强制 3位数字** (如 "101")。
*   `abbreviation`: 2-3位字母 (如 "HL")。

### 4.2 车辆表 (`product_vehicles`)
*   `code`: **强制定长数字**。
    *   Make 节点: 2位 (如 "01")。
    *   Model 节点: 2位 (如 "05")。
    *   Platform 节点: 2位 (如 "01") - 仅存储，不进 SKU。
    *   Year 节点: 不参与 SKU 数字码。

### 4.3 变体表 (`product_variants`)
重构以适应双轨制：
```python
class ProductVariant(db.Model):
    # ...
    # 1. 仓库唯一码 (数字+后缀)
    sku: str = "101120501DWD"
    
    # 2. 业务特征码 (SPU + 属性)
    feature_code: str = "HL-TOY-CAM-20-D-WB"
    
    # 3. 移除废弃字段
    # - suffix_code (移除)
    # - supplier_sku (移除)
```

---

## 5. 业务逻辑与算法

### 5.1 双轨制生成流程 (Updated)

系统通过 `attribute_scope` 和 `include_in_code` 两个字段组合控制生成逻辑。

#### A. 控制矩阵

| 业务场景 | Scope (属性作用域) | IncludeCode (进短码) | System SKU 表现 | Feature Code 表现 | 示例 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **隐式变体** | `sku` | `False` | **无后缀** (触发新流水号 01->02) | **生成段** (BK) | 颜色、电压 |
| **显式变体** | `sku` | `True` | **生成后缀** (L/R, 复用流水号) | **生成段** (D) | 位置 |
| **纯描述** | `spu` | `False` | 不参与 | 不参与 | 材质 |

#### B. SKU 生成步骤

1.  **分组处理**:
    *   将前端传入的所有变体按 **隐式变体属性组合** (即 `attribute_scope='sku'` 且 `include_in_code=False` 的属性值集合) 进行分组。
    *   例如: 输入 `[L-Black, R-Black, L-Chrome, R-Chrome]`。
    *   分组结果:
        *   Group Black: `[L-Black, R-Black]`
        *   Group Chrome: `[L-Chrome, R-Chrome]`

2.  **原子流水号分配**:
    *   对每个 Group，申请一个独立的原子流水号。
    *   Group Black -> 申请 Serial 01 (检查 01+L 和 01+R 是否均不冲突)。
    *   Group Chrome -> 申请 Serial 02。
    
3.  **生成 SKU**:
    *   L-Black -> `...01L`
    *   R-Black -> `...01R`
    *   L-Chrome -> `...02L`
    *   R-Chrome -> `...02R`

4.  **写入数据库**: 只有当整组变体都预检通过后，才执行写入操作。

#### C. 特征码生成步骤

1.  **SPU 部分**: `HL-TOY-CAM-07-11` (由 SPU 元数据生成)。
2.  **变体部分**:
    *   遍历所有 `attribute_scope='sku'` 的属性 (无论 IncludeCode 是 True 还是 False)。
    *   获取 Option 代码 (如 "BK", "D")。
    *   按 `code_weight` 排序后拼接。
3.  **组装**: `HL-TOY-CAM-07-11-BK-D`。

### 5.2 属性后缀排序
*   **规则**: 按照全局属性定义的 `code_weight` 排序。
*   **目的**: 确保 `BK-D` 和 `D-BK` 生成顺序一致。

---

## 6. 实施步骤 (Phase 6)

1.  **数据清洗**: 为所有 Brand 和 Model 分配数字编码。
2.  **后端升级**: 更新 `product_vehicles` API 返回 Code，更新 `product_variants` 表结构。
3.  **前端改造**: `create.vue` 实现 9位 SKU 生成算法。
4.  **UI 优化**: 变体列表展示双列预览 (SKU & Feature Code)。

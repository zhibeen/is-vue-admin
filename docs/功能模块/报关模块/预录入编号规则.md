# 预录入编号规则说明

## 📋 编号格式

```
{公司代码}-YL-{年月}-{流水号}
```

**示例**：
- `HR-YL-2412-0001` （华瑞公司，2024年12月，第1单）
- `NB-YL-2412-0156` （宁波公司，2024年12月，第156单）
- `SZ-YL-2501-0001` （深圳公司，2025年1月，第1单）

## 🔧 各部分说明

| 部分 | 说明 | 长度 | 示例 |
|------|------|------|------|
| **公司代码** | 境内发货人公司的唯一标识 | 2-4位 | `HR`, `NB`, `SZ` |
| **YL** | 固定前缀，代表"预录" | 2位 | `YL` |
| **年月** | YYMM格式 | 4位 | `2412` |
| **流水号** | 按公司按月递增 | 4位（补0） | `0001` |

## ✨ 特性

- ✅ **按公司隔离**：每个境内发货人有独立的编号序列
- ✅ **按月重置**：每月流水号从0001开始
- ✅ **可追溯性**：从编号可直接识别公司和月份
- ✅ **避免冲突**：使用Redis原子递增，保证唯一性
- ✅ **自动生成**：创建报关单时自动生成，无需手动输入

## 🎯 使用方式

### 1. 后端自动生成

在创建报关单时，只需提供 `internal_shipper_id`（境内发货人ID），系统会自动生成预录入编号：

```python
from app.services.customs_service import customs_service

# 创建报关单
data = {
    'internal_shipper_id': 1,  # 境内发货人ID
    'export_date': '2024-12-17',
    # ... 其他字段
}

declaration = customs_service.create_declaration(data)
print(declaration.pre_entry_no)  # 输出: HR-YL-2412-0001
```

### 2. 前端显示

#### 详情页显示
预录入编号会显示在报关单详情页面的右上角：

```vue
<div class="flex items-center">
  <span class="text-muted-foreground">预录入编号：</span>
  <span class="font-mono text-primary font-semibold">
    {{ detail.pre_entry_no }}
  </span>
</div>
```

#### 列表页显示
预录入编号作为独立列展示在报关单列表中。

## 🏢 公司代码配置

当前已配置的公司代码：

| 公司名称关键词 | 公司代码 | 示例编号 |
|--------------|---------|---------|
| 华瑞 | `HR` | `HR-YL-2412-0001` |
| 宁波（非华瑞） | `NB` | `NB-YL-2412-0001` |
| 深圳 | `SZ` | `SZ-YL-2412-0001` |
| 广州 | `GZ` | `GZ-YL-2412-0001` |
| 上海 | `SH` | `SH-YL-2412-0001` |
| 北京 | `BJ` | `BJ-YL-2412-0001` |

### 新增公司代码

如需为新公司添加代码，请在数据库中更新 `sys_companies.code` 字段：

```sql
UPDATE sys_companies 
SET code = 'XX' 
WHERE id = {公司ID};
```

或通过系统管理界面配置。

## 🔍 API 接口

### 生成预录入编号

**自动生成**（推荐）：
```
POST /api/v1/customs/declarations
{
  "internal_shipper_id": 1,
  ...
}
```
系统会自动生成 `pre_entry_no`。

**手动生成**（特殊情况）：
```python
from app.services.customs_service import customs_service

pre_entry_no = customs_service.generate_pre_entry_no(
    internal_shipper_id=1
)
```

## ⚠️ 注意事项

1. **公司代码必填**：如果公司未设置 `code` 字段，系统会跳过预录入编号生成，但不会阻止报关单创建
2. **唯一性保证**：基于 Redis 原子递增，确保流水号唯一
3. **降级策略**：如果 Redis 不可用，会使用随机数作为降级方案
4. **不可修改**：预录入编号一旦生成，原则上不应修改

## 🚀 扩展

如需要更复杂的编号规则（如增加业务线、关区等），可以修改 `generate_seq_no` 函数的调用方式：

```python
# 示例：增加业务线标识
pre_entry_no = generate_seq_no(
    prefix="YL-B2B",  # 预录-B2B业务
    company_code=company_code
)
# 输出: HR-YL-B2B-2412-0001
```

---

**技术支持**：如有问题请联系系统管理员
**最后更新**：2024-12-17


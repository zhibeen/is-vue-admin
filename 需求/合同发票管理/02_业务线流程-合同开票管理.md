# 业务线流程：合同开票管理

## 🎯 流程概述

业务线以内贸业务为核心，从发货单出发，通过合同管理、付款跟踪，最终完成开票管理的完整业务流程。

## 🔄 完整业务流程

```
发货单数据输入 → 合同管理 → 付款跟踪 → 开票管理
```

## 📋 详细流程步骤

### 步骤1：发货单数据输入

#### 1.1 数据源：采购发货明细表
```
发货单关键字段：
├── 基础信息
│   ├── 发货单号
│   ├── 采购单号
│   └── 发货日期
├── 商品信息
│   ├── SKU
│   ├── 品名
│   ├── 出库量
│   └── 单位
├── 供应商信息
│   ├── 供应商名称
│   ├── 供应商税号
│   └── 发票税率
└── 成本信息
    ├── 单位采购成本
    ├── 单位出库成本
    └── 单位费用
```

#### 1.2 数据验证规则
- **完整性检查**：必填字段验证
- **格式验证**：SKU格式、金额格式
- **业务验证**：供应商有效性、商品存在性
- **重复检查**：发货单号唯一性

### 步骤2：合同管理

#### 2.1 合同生成方式
**方式一：智能批量生成（推荐）**
```python
def 批量生成合同(发货单数据):
    # 按供应商分组
    供应商分组 = 发货单数据.groupby('供应商')
    
    合同列表 = []
    for 供应商, 分组数据 in 供应商分组:
        # 获取购项公司信息
        购项公司 = 获取默认购项公司()
        
        # 创建合同（自动生成编号）
        合同 = 创建合同_自动编号(
            购项公司ID=购项公司.id,
            供应商ID=供应商.id,
            合同日期=datetime.now()
        )
        
        # 转换商品行
        for 行数据 in 分组数据.iterrows():
            # 通过SKU查询商品信息
            商品信息 = 查询商品信息(行数据.SKU)
            
            # 创建合同项
            合同项 = 创建合同项(
                商品名称=商品信息.customs_name,
                数量=行数据.出库量,
                单价=行数据.单位采购成本,
                单位=商品信息.单位,
                税率=行数据.发票税率
            )
            合同.添加合同项(合同项)
        
        合同列表.append(合同)
        
        # 生成送货单明细
        送货单 = 生成送货单明细(合同, 分组数据)
        合同.关联送货单(送货单)
    
    return 合同列表
```

#### 2.1.1 合同编号自动生成规则
**编号格式：** `[公司缩写] + [年月日] + [三位流水号]`

**示例：**
- `ABC20241119001` - ABC公司2024年11月19日的第1份合同
- `XYZ20241119001` - XYZ公司同一天的第1份合同  
- `ABC20241119002` - ABC公司同一天的第2份合同

**规则说明：**
- **公司缩写**：从购项公司表 `purchasing_companies` 的 `company_abbr` 字段获取
- **年月日**：合同日期的 `YYYYMMDD` 格式
- **流水号**：每天从001开始的三位数字，按创建顺序递增
- **唯一性**：确保同一公司同一天内编号唯一

**技术实现：**
```python
# 使用 ContractNumberService 自动生成编号
from src.services.contract_number_service import ContractNumberService

service = ContractNumberService()
contract_info = service.create_contract_with_auto_number(
    purchasing_company_id=1,
    supplier_id=1,
    contract_date=datetime.now()
)
print(f"生成的合同编号: {contract_info['contract_number']}")
```

**方式二：手工录入合同**
- 适用于特殊业务场景
- 支持数据联动计算
- 模板化快速录入

#### 2.2 合同状态管理
```
合同状态流转：
草稿 → 已确认 → 付款中 → 部分开票 → 已完成 → 已归档
```

#### 2.3 合同关键信息
```
合同基本信息：
├── 合同编号：[自动生成]
├── 供应商：[从发货单获取]
├── 购项公司：[选择]
├── 合同日期：[选择]
├── 合同总金额：[自动计算]
└── 合同状态：[自动更新]

合同商品明细：
┌──┬──────────┬──────┬──────┬──────┬──────┬────────┐
│行│商品名称  │数量  │单价  │税率  │金额  │已开票量│
├──┼──────────┼──────┼──────┼──────┼──────┼────────┤
│1 │[自动填充]│[自动]│[自动]│[自动]│[自动]│[0]     │
│2 │[自动填充]│[自动]│[自动]│[自动]│[自动]│[0]     │
└──┴──────────┴──────┴──────┴──────┴──────┴────────┘
```

### 步骤3：付款跟踪

#### 3.1 付款记录管理
```
付款信息记录：
├── 基础信息
│   ├── 付款日期
│   ├── 付款金额
│   ├── 付款方式
│   └── 凭证号码
├── 关联信息
│   ├── 关联合同
│   ├── 关联供应商
│   └── 关联发票
└── 状态信息
    ├── 付款状态
    ├── 审核状态
    └── 完成状态
```

#### 3.2 付款状态跟踪
```
付款状态：
待付款 → 付款中 → 已付款 → 已确认

合同付款进度：
合同总金额：¥100,000
已付款金额：¥60,000 (60%)
待付款金额：¥40,000 (40%)
```

#### 3.3 付款提醒机制
- **逾期提醒**：超过约定付款日期
- **即将到期**：付款日前3天提醒
- **大额付款**：超过阈值需要审批
- **异常付款**：金额不匹配预警

### 步骤4：开票管理

#### 4.1 开票申请流程
```
开票申请步骤：
1. 选择开票合同
2. 确认开票商品和数量
3. 填写开票申请信息
4. 提交申请审核
5. 审核通过后开票
```

#### 4.2 发票录入
**方式一：手工录入发票**
```
发票信息表单：
├── 发票基本信息
│   ├── 发票号码：[输入]
│   ├── 开票日期：[选择]
│   ├── 发票类型：[选择]
│   └── 发票状态：[选择]
├── 公司信息
│   ├── 销项公司：[自动填充]
│   ├── 购项公司：[自动填充]
│   └── 税号信息：[自动填充]
└── 商品明细
    └── [从合同自动加载]
```

**方式二：Excel导入发票**
- 支持税务系统标准格式
- 自动解析发票数据
- 数据验证和去重
- 错误数据提示

#### 4.3 发票状态管理
```
发票状态流转：
待开票 → 已开票 → 已收到 → 已认证 → 已匹配 → 已退税
```

#### 4.4 发票数据验证
- **发票号唯一性**：系统内不能重复
- **金额一致性**：发票金额=申请金额
- **商品一致性**：发票商品=合同商品
- **时间合理性**：开票日期≥合同日期

## 🔗 数据关联关系

### 核心数据关联
- **发货单 → 合同**：1:N关系，一个发货单可生成多个合同
- **合同 → 付款记录**：1:N关系，一个合同可有多次付款
- **合同 → 发票**：1:N关系，一个合同可开多张发票
- **发票 ←→ 报关单**：通过匹配建立关联

### 状态联动规则
- **付款完成** → 更新合同付款状态
- **发票开具** → 更新合同开票状态
- **发票认证** → 更新发票认证状态
- **匹配成功** → 更新退税资格状态

## 🎯 关键业务特性

### 智能计算
- **实时计算**：数量×单价=金额自动计算
- **汇总统计**：合同总金额自动汇总
- **进度跟踪**：付款进度、开票进度实时更新
- **余额计算**：待付款、待开票金额自动计算

### 数据联动
- **选择商品**：自动填充单位、税率
- **修改数量**：自动重新计算金额
- **更新单价**：自动更新行金额和总金额
- **状态变更**：自动触发相关业务逻辑

### 批量操作
- **批量生成合同**：多个发货单同时处理
- **批量付款记录**：多笔付款同时录入
- **批量开票申请**：多合同同时申请开票
- **批量数据导入**：Excel模板批量导入

## 🔧 技术实现要点

### 数据一致性保障
- 事务处理确保数据完整
- 乐观锁防止并发冲突
- 数据验证前置检查
- 异常回滚机制

### 性能优化策略
- 分页加载大量数据
- 缓存常用查询结果
- 异步处理文件上传
- 批量操作支持

### 安全性设计
- 操作权限控制
- 数据访问权限
- 操作日志记录
- 敏感数据加密

## 📊 质量控制机制

### 数据准确性
- 自动计算验证
- 金额平衡检查
- 关联数据一致性
- 历史数据追溯

### 业务流程
- 状态流转控制
- 操作权限验证
- 审批流程支持
- 操作日志记录

### 异常处理
- 数据格式错误处理
- 业务逻辑异常处理
- 系统级错误处理
- 用户友好提示

---

**文档版本**：v1.0  
**创建日期**：2025-11-19  
**维护者**：AI Assistant

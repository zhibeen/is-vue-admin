# 02-产品数据库设计

基于 PostgreSQL 15+ 和 SQLAlchemy 2.0 的数据库架构设计。

## 1. 核心设计理念
- **混合存储**: 结构化数据 (SKU, 价格, 库存) 使用标准列，非结构化/动态数据 (产品属性) 使用 `JSONB`。
- **树形结构**: 分类和车型采用邻接表 (`parent_id`) 设计，支持无限层级。
- **高性能检索**: 利用 PG 的 GIN 索引加速 JSONB 查询和全文检索。

## 2. 表结构概览

### 2.1 基础分类与属性元数据 (Metadata)

#### `categories` (产品类别树)
管理产品的物理归属，如 "汽车照明 > 前大灯"。
```sql
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    parent_id INTEGER REFERENCES categories(id),
    name VARCHAR(100) NOT NULL,
    code VARCHAR(10) UNIQUE,  -- 类目编码，如 "188", "HDL"
    level INTEGER,            -- 层级深度 (缓存字段，可选)
    is_leaf BOOLEAN DEFAULT FALSE, -- 是否为叶子节点
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### `attribute_definitions` (属性池)
定义系统中所有可用的属性 Key，统一管理名称和类型。
```sql
CREATE TABLE attribute_definitions (
    id SERIAL PRIMARY KEY,
    key_name VARCHAR(50) UNIQUE NOT NULL, -- 内部标识，如 "voltage", "lens_color"
    label VARCHAR(100) NOT NULL,          -- 显示名称，如 "电压", "透镜颜色"
    data_type VARCHAR(20) NOT NULL,       -- "text", "number", "select", "boolean"
    options JSONB,                        -- 如果是 select，存储选项列表 ["12V", "24V"]
    is_global BOOLEAN DEFAULT FALSE       -- 是否所有产品通用的全局属性
);
```

#### `category_attributes` (类目-属性绑定)
定义某类产品可以使用哪些属性。
```sql
CREATE TABLE category_attributes (
    category_id INTEGER REFERENCES categories(id),
    attribute_id INTEGER REFERENCES attribute_definitions(id),
    is_required BOOLEAN DEFAULT FALSE,
    display_order INTEGER DEFAULT 0,
    PRIMARY KEY (category_id, attribute_id)
);
```

---

### 2.2 车型库 (Vehicle Master Data)

#### `vehicles` (车型标准库 YMMS)
存储 Make -> Model -> Year -> SubModel 树。
建议引入层级类型字段来区分节点性质。
```sql
CREATE TABLE vehicles (
    id SERIAL PRIMARY KEY,
    parent_id INTEGER REFERENCES vehicles(id),
    name VARCHAR(100) NOT NULL, -- "Toyota", "Camry", "2020"
    level_type VARCHAR(20),     -- "make", "model", "year", "trim", "engine"
    full_path VARCHAR(255)      -- 路径缓存，如 "Toyota/Camry/2020/LE"
);
-- 索引建议: 创建 GIN 索引加速模糊搜索
```

---

### 2.3 产品核心 (Product Core)

#### `sku_suffixes` (SKU 后缀字典)
管理 SKU 变体后缀规则。
```sql
CREATE TABLE sku_suffixes (
    code VARCHAR(5) PRIMARY KEY, -- "L", "R", "B"
    meaning_en VARCHAR(50),
    meaning_cn VARCHAR(50),
    category_id INTEGER REFERENCES categories(id) -- 可空，空代表通用
);
```

#### `products` (产品主表)
```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    
    -- 编码体系
    sku VARCHAR(50) UNIQUE NOT NULL,        -- 机器码: "188010051L"
    feature_code VARCHAR(100),              -- 语义码: "HL-CHE-SIL-99-02..."
    
    -- 基础信息
    category_id INTEGER REFERENCES categories(id), -- 物理分类
    name VARCHAR(200) NOT NULL,
    
    -- 变体管理
    parent_sku_id INTEGER REFERENCES products(id), -- 若有值，则是变体
    suffix_code VARCHAR(5) REFERENCES sku_suffixes(code),
    
    -- 核心规格
    length DECIMAL(10,2),
    width DECIMAL(10,2),
    height DECIMAL(10,2),
    weight DECIMAL(10,2),
    
    -- 动态属性 (核心设计)
    -- 存储结构: { "voltage": "12V", "lens_color": "Clear", "material": "ABS" }
    attributes JSONB DEFAULT '{}'::jsonb,
    
    -- AI 检索增强
    full_text_description TEXT, -- 自动生成的长文本描述
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引: 加速 JSONB 任意键值对查询
CREATE INDEX idx_products_attributes ON products USING GIN (attributes);
```

---

### 2.4 关联关系 (Relations)

#### `product_fitments` (车型适配表)
多对多关联。
```sql
CREATE TABLE product_fitments (
    product_id INTEGER REFERENCES products(id),
    vehicle_id INTEGER REFERENCES vehicles(id), -- 通常关联到 Year 或 Trim 层级
    notes VARCHAR(200), -- 备注，如 "仅适用于运动版"
    PRIMARY KEY (product_id, vehicle_id)
);
```

## 3. SQLAlchemy 2.0 模型映射示例 (Python)

```python
# backend/app/models/product.py

from typing import Optional, List
from sqlalchemy import String, Integer, ForeignKey, DECIMAL
from sqlalchemy.dialects.postgresql import JSONB
from sqlalchemy.orm import Mapped, mapped_column, relationship
from app.extensions import db

class Product(db.Model):
    __tablename__ = "products"
    
    id: Mapped[int] = mapped_column(primary_key=True)
    sku: Mapped[str] = mapped_column(String(50), unique=True, index=True)
    feature_code: Mapped[Optional[str]] = mapped_column(String(100))
    name: Mapped[str] = mapped_column(String(200))
    
    # 外键
    category_id: Mapped[int] = mapped_column(ForeignKey("categories.id"))
    
    # 动态属性
    attributes: Mapped[dict] = mapped_column(JSONB, default={})
    
    # 关系
    category: Mapped["Category"] = relationship(back_populates="products")
    fitments: Mapped[List["Vehicle"]] = relationship(secondary="product_fitments")
```

## 4. 关键业务逻辑实现思路

### 4.1 属性验证
在写入 `products.attributes` 前，必须校验：
1.  获取 `product.category_id`。
2.  查询 `category_attributes` 获取该分类允许的 keys。
3.  验证提交的 JSON 是否包含非法 key，以及值类型是否正确。

### 4.2 SKU 自动生成 (SQL)
查询当前最大流水号的 SQL 逻辑：
```sql
-- 假设前缀是 "18801"
SELECT sku FROM products 
WHERE sku LIKE '18801%' 
AND sku ~ '^18801\d{4}[A-Z]*$' -- 正则过滤脏数据
ORDER BY LENGTH(sku) DESC, sku DESC 
LIMIT 1;
```


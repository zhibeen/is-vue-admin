# 01-产品管理需求分析

## 1. 业务目标
构建一个灵活的汽配产品管理系统 (PIM)，支持复杂的多维分类、动态属性管理，并为未来接入 AI RAG (检索增强生成) 提供结构化的高质量数据。

## 2. 核心数据模型设计

### 2.1 基础信息 (Base Info)
所有产品共有的核心字段，用于基础库存和物流管理。
- **ID**: 系统唯一主键
- **SPU/SKU**: 库存单元编码 (用于机器识别、库存管理)
- **Feature Code (特征码)**: 业务语义编码 (用于人工识别、AI检索)
- **Name (品名)**: 产品标准名称
- **Images**: 多图管理 (主图、细节图、尺寸图)
- **Physical Specs**: 
  - 尺寸 (长/宽/高)
  - 重量 (净重/毛重)
  - 包装规格

### 2.2 双重目录结构 (Dual Taxonomy)

#### A. 产品类别目录 (Product Category Tree)
*   **定义**: 基于产品物理属性的分类。**决定了产品拥有哪些扩展属性。**
*   **结构**: 多级树 (无限层级)。
*   **规则**: 一个产品必须且只能属于**一个**底层叶子节点分类。
*   **示例**: 
    - 汽车照明
        - 前大灯
        - 尾灯
    - 车身覆盖件
        - 保险杠

#### B. 车型目录/适配性 (Vehicle Fitment Tree)
*   **定义**: 基于适用的汽车层级。
*   **结构**: 多级树 (Make -> Model -> Year -> Trim)。
*   **规则**: **多对多关联**。一个产品可以适配多个车型节点。
*   **实现建议**: 建立独立的标准车型库 (YMMS)，产品通过中间表关联车型 ID。

### 2.3 动态属性系统 (Dynamic Attribute System)
解决不同品类拥有不同属性的痛点。

#### 设计逻辑:
1.  **属性池 (Attribute Pool)**: 维护所有可能的属性定义 (Key)，如 "材质", "电压", "流明", "透镜类型"。
    - 字段: `Attribute Name`, `Data Type` (Text/Number/Select), `Options` (如果是下拉选)。
2.  **类目-属性绑定 (Category-Attribute Mapping)**:
    - 在“产品类别”上配置该类别有哪些“可用属性”。
    - 支持继承：子类目自动继承父类目的属性。
3.  **产品属性值 (Product Attribute Values)**:
    - 存储实际的值 (Value)。
    - 数据结构 (JSONB 推荐): `{ "Voltage": "12V", "Lens_Color": "Clear" }`。

#### 场景模拟:
- 当用户创建产品并选择类别为 **"汽车大灯"** 时：
- 后端查询该类别绑定的属性模板。
- 前端动态渲染出 "电压", "灯泡接口", "透镜颜色" 等输入框。
- "材质" 这种通用属性可能在根目录就绑定了，所有产品都会显示。

### 2.5 SKU 编码策略 (Smart SKU Generation)
SKU 是仓库管理的唯一凭证，一旦生成不可变更。

#### 编码结构
采用 **混合分段编码**，兼容历史数据，支持变体后缀。
格式: `AAABBNNNN{S}` (示例: `188010051L`)

| 字段 | 长度 | 说明 | 来源 |
| :--- | :--- | :--- | :--- |
| **Category (类目)** | 3 | 物料类别码，如 188 (保险杠) | 关联 `category.code` |
| **Make (车型)** | 2 | 适用主品牌，如 02 (宝马) | 关联 `brand.code` (需维护映射表) |
| **Serial (流水)** | 4 | 同类目同品牌下的自增序号 (0001-9999) | 系统自动计算 (Max+1) |
| **Suffix (后缀)** | 1-2 | 变体标识 (可选)，如 L, R, B | 关联 `Suffix Dictionary` |

#### Category Code 继承逻辑 (就近原则)
针对多级目录 (如一级 "188 保险杠" -> 二级 "189 前保")，系统生成 SKU 时遵循以下逻辑：
1.  取产品直接挂载的分类 (如 "前保")。
2.  若该分类有 `code` (189)，则使用 `189`。
3.  若该分类无 `code`，则向上追溯父级，直到找到有 `code` 的节点 (如 `188`)。
这允许灵活定义：通用类产品使用父级码，细分产品使用子级码。

#### 变体后缀字典 (Suffix Dictionary)
系统维护一套可扩展的后缀含义表，供程序解析和前端选择：

| Suffix | Meaning (EN) | Meaning (CN) | 适用范围 |
| :--- | :--- | :--- | :--- |
| **L** | Left / Driver Side | 左侧/驾驶位 | 通用 |
| **R** | Right / Pass. Side | 右侧/副驾位 | 通用 |
| **D** | Driver Side | 驾驶位 (兼容旧) | 通用 |
| **P** | Passenger Side | 副驾位 (兼容旧) | 通用 |
| **C** | Chrome | 镀铬 | 车灯/格栅 |
| **B** | Black | 黑色 | 车灯/格栅 |
| **S** | Set / Pair | 套装/对 | 通用 |

#### 生成与防撞逻辑
1.  **构建前缀**: 根据用户选定的类目(188)和品牌(01)，确定前缀 `prefix = "18801"`.
2.  **探查水位**: 查询 DB 中所有 `sku LIKE '18801%'` 的记录。
3.  **计算流水**:
    - 过滤非标准格式，提取最大的纯数字流水号 N。
    - 新流水 `Next = N + 1` (如 0051 -> 0052)。
    - **防撞**: 若计算出的 SKU 已存在 (如并发情况)，自动 `Next + 1` 重试。
4.  **拼接后缀**: 若用户选择了“左侧 (L)”，则追加 `L`。
5.  **最终输出**: `188010052L`。

### 2.6 特征码 (Feature Code) 逻辑
特征码是产品的“业务身份证”，方便人工快速识别产品特性，**不用于库存管理，可修正**。

- **结构示例**: `HL-CHE-SIL-99-02-2P-CH-CL-AM`
- **解析逻辑**:
  1.  `HL`: **Category Code** (大灯)
  2.  `CHE-SIL`: **Make-Model** (雪佛兰-索罗德)
  3.  `99-02`: **Year Range** (适配年份)
  4.  `2P`: **Attribute** (2件套)
  5.  `CH`: **Attribute** (镀铬底)
  6.  `CL`: **Attribute** (透明罩)
  7.  `AM`: **Attribute** (琥珀反光)
- **生成策略**: 配置规则引擎，当产品属性变动时，自动建议更新特征码。

## 3. AI RAG 数据准备
为未来的 AI 搜索做准备，数据存储需注意：

1.  **结构化文本化**: 在保存产品时，自动生成一段 **"Full Text Description"**。
    - *Template*: "这是一适用于 [车型列表] 的 [产品名称]。主要特征包含：[属性列表文本化]..."
    - 作用: 直接作为 Embedding 的输入源。
2.  **特征码语义**: 特征码本身不仅是 ID，也是高效的检索 Token。

## 4. API 接口规划概览 (Draft)

### 产品管理
- `POST /api/v1/products`: 创建产品 (包含属性值 JSON, 自动生成 SKU)
- `GET /api/v1/products/{id}`: 获取详情 (包含计算后的完整属性)
- `GET /api/v1/products/generate-feature-code`: 根据当前表单数据预览特征码

### 目录与属性
- `GET /api/v1/categories/{id}/attributes`: 获取某分类下的所有动态属性定义 (用于前端渲染表单)
- `POST /api/v1/categories/{id}/attributes`: 为分类绑定属性

### 车型适配
- `POST /api/v1/products/{id}/fitments`: 批量添加适配车型

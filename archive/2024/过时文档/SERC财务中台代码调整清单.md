# SERCè´¢åŠ¡ä¸­å°ç³»ç»Ÿ - ä»£ç è°ƒæ•´æ¸…å•

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.1  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-19  
> **æœ€åæ›´æ–°**: 2025-12-19  
> **ä¾æ®æ–‡æ¡£**: ã€ŠSERCè´¢åŠ¡ä¸­å°å®æ–½è·¯çº¿å›¾ã€‹  
> **ä»£ç åº“ä½ç½®**: `D:\jzb_program\is-vue-admin`

---

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†åˆ—å‡ºäº†åŸºäºã€ŠSERCè´¢åŠ¡ä¸­å°å®æ–½è·¯çº¿å›¾ã€‹éœ€è¦è°ƒæ•´ã€æ‰©å±•æˆ–æ–°å»ºçš„ä»£ç æ–‡ä»¶ï¼ŒæŒ‰6ä¸ªå®æ–½é˜¶æ®µç»„ç»‡ã€‚

### 1.1 è°ƒæ•´ç±»å‹è¯´æ˜

- ğŸ†• **æ–°å»º** - éœ€è¦æ–°å»ºçš„æ–‡ä»¶
- ğŸ”§ **è°ƒæ•´** - éœ€è¦ä¿®æ”¹çš„ç°æœ‰æ–‡ä»¶
- âœ… **æ— éœ€è°ƒæ•´** - ç°æœ‰æ–‡ä»¶æ— éœ€æ”¹åŠ¨
- ğŸ—‘ï¸ **åºŸå¼ƒ** - é€æ­¥åºŸå¼ƒçš„æ–‡ä»¶ï¼ˆå‘åå…¼å®¹ï¼‰
- â¸ï¸ **æš‚ç¼“** - æš‚ä¸å®æ–½çš„åŠŸèƒ½

### 1.2 é‡è¦ä¸šåŠ¡çº¦æŸ

> âš ï¸ **å…³é”®è¯´æ˜**ï¼š
> 
> 1. **ç‰©æµè´¹ç”¨æ‰‹å·¥å½•å…¥**
>    - ç‰©æµæœåŠ¡å•†ï¼ˆæµ·è¿ã€ç©ºè¿ã€é™†è¿ç­‰ï¼‰**æ²¡æœ‰APIæ¥å£**
>    - å¤´ç¨‹è´¹ç”¨ï¼ˆè¿è´¹ã€ä¿é™©è´¹ã€æ“ä½œè´¹ç­‰ï¼‰é‡‡ç”¨**æ‰‹å·¥å½•å…¥**æ–¹å¼
>    - ä¸æ¶‰åŠè‡ªåŠ¨å¯¹è´¦åŠŸèƒ½ï¼Œå¯¹è´¦å•ç”±è´¢åŠ¡äººå‘˜æ ¹æ®æœåŠ¡å•†æä¾›çš„è´¦å•æ‰‹å·¥æ ¸å¯¹åå½•å…¥ç³»ç»Ÿ
> 
> 2. **å¯¹æ¥APIåŠŸèƒ½æš‚ç¼“**
>    - "è‡ªåŠ¨å¯¹æ¥ç‰©æµæœåŠ¡å•†API"åŠŸèƒ½**æš‚ç¼“å¼€å‘**
>    - "è‡ªåŠ¨è·å–è´¹ç”¨"åŠŸèƒ½**æš‚ç¼“å¼€å‘**
>    - æœªæ¥å¦‚æœ‰ç‰©æµæœåŠ¡å•†æä¾›APIï¼Œå¯åœ¨åç»­ç‰ˆæœ¬æ‰©å±•
> 
> 3. **æ ¸å¿ƒå®æ–½èŒƒå›´**
>    - ç‰©æµæœåŠ¡å•†ä¸»æ•°æ®ç®¡ç†ï¼ˆæ‰‹å·¥ç»´æŠ¤ï¼‰
>    - ç‰©æµæœåŠ¡æ˜ç»†å½•å…¥ï¼ˆæ‰‹å·¥å¡«å†™é¢„ä¼°/å®é™…è´¹ç”¨ï¼‰
>    - ç‰©æµå¯¹è´¦å•ç”Ÿæˆï¼ˆåŸºäºå·²å½•å…¥çš„è´¹ç”¨ï¼‰
>    - å‡­è¯ä¸Šä¼ ï¼ˆæœåŠ¡å‡­è¯ã€ä»˜æ¬¾å‡­è¯æ‰‹å·¥ä¸Šä¼ ï¼‰
>    - ä»˜æ¬¾ç®¡ç†ï¼ˆè¿›å…¥ä»˜æ¬¾æ± ç»Ÿä¸€è°ƒåº¦ï¼‰

---

## äºŒã€é˜¶æ®µ0ï¼šå‡†å¤‡é˜¶æ®µï¼ˆæ–‡æ¡£æ¢³ç†ï¼‰

### 2.1 è¯¦ç»†è®¾è®¡æ–‡æ¡£ï¼ˆéœ€æ–°å»ºï¼‰

| åºå· | æ–‡æ¡£åç§° | è·¯å¾„ | è¯´æ˜ |
|------|---------|------|------|
| 1 | ç‰©æµæœåŠ¡å•†ä¸å¯¹è´¦ç®¡ç†è¯¦ç»†è®¾è®¡ | `å¼€å‘è®¾è®¡æ–‡æ¡£/ç‰©æµæ¨¡å—/ç‰©æµæœåŠ¡å•†ä¸å¯¹è´¦ç®¡ç†è®¾è®¡.md` | æ•°æ®æ¨¡å‹ã€APIæ¥å£ã€ä¸šåŠ¡æµç¨‹ |
| 2 | å‡­è¯ç®¡ç†ç³»ç»Ÿè¯¦ç»†è®¾è®¡ | `å¼€å‘è®¾è®¡æ–‡æ¡£/ç‰©æµæ¨¡å—/å‡­è¯ç®¡ç†ç³»ç»Ÿè®¾è®¡.md` | å‡­è¯ä¸­å¿ƒæ¶æ„ã€ä¸Šä¼ å½’æ¡£æµç¨‹ |
| 3 | ä»˜æ¬¾æ± æ‰©å±•è®¾è®¡ | `å¼€å‘è®¾è®¡æ–‡æ¡£/è´¢åŠ¡æ¨¡å—/ä»˜æ¬¾æ± æ‰©å±•è®¾è®¡.md` | ä»˜æ¬¾æ± ç±»å‹æ‰©å±•ã€ç»Ÿä¸€è°ƒåº¦ |

---

## ä¸‰ã€é˜¶æ®µ1ï¼šåŸºç¡€æ•°æ®æ¨¡å‹ï¼ˆ2-3å¤©ï¼‰

### 3.1 åç«¯ - æ•°æ®åº“è¿ç§»

#### ğŸ“‚ `backend/migrations/versions/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `[timestamp]_add_logistics_providers_and_document_center.py` | ğŸ†• æ–°å»º | åˆ›å»ºç‰©æµæœåŠ¡å•†è¡¨å’Œå‡­è¯ç®¡ç†ä¸­å¿ƒè¡¨ |

**è¿ç§»å†…å®¹**ï¼š

1. **åˆ›å»º `logistics_providers` è¡¨**
   ```python
   # æ ¸å¿ƒå­—æ®µ
   - id (ä¸»é”®)
   - provider_name (æœåŠ¡å•†åç§°)
   - provider_code (æœåŠ¡å•†ç¼–ç , unique)
   - service_type (æœåŠ¡ç±»å‹: é™†è¿/æµ·è¿/ç©ºè¿/æ¸…å…³/æ´¾é€)
   - payment_method (ä»˜æ¬¾æ–¹å¼: å³ä»˜/é¢„ä»˜/åä»˜)
   - settlement_cycle (ç»“ç®—å‘¨æœŸ: å³æ—¶/å‘¨ç»“/æœˆç»“)
   - contact_name (è”ç³»äºº)
   - contact_phone (è”ç³»ç”µè¯)
   - contact_email (é‚®ç®±)
   - bank_name (å¼€æˆ·é“¶è¡Œ)
   - bank_account (é“¶è¡Œè´¦å·)
   - bank_account_name (è´¦æˆ·åç§°)
   - service_areas (æœåŠ¡åŒºåŸŸ, ARRAY)
   - is_active (å¯ç”¨çŠ¶æ€, default=True)
   - notes (å¤‡æ³¨)
   - created_at, updated_at
   ```

2. **åˆ›å»º `document_center` è¡¨**ï¼ˆé€šç”¨å‡­è¯ç®¡ç†ï¼‰
   ```python
   # æ ¸å¿ƒå­—æ®µ
   - id (ä¸»é”®)
   - business_type (ä¸šåŠ¡ç±»å‹: logistics/purchase/customs/payment)
   - document_type (å‡­è¯ç±»å‹: è¿å•/æå•/æ¸…å…³å•/å‘ç¥¨/æŠ¥å…³å•/ä»˜æ¬¾å•ç­‰)
   - document_category (æ–‡æ¡£åˆ†ç±»: æœåŠ¡å‡­è¯/ä»˜æ¬¾å‡­è¯/åˆåŒå‡­è¯ç­‰)
   - business_id (ä¸šåŠ¡å•æ®ID, å¤–é”®æ ¹æ®business_typeåŠ¨æ€å…³è”)
   - business_no (ä¸šåŠ¡å•æ®ç¼–å·, å†—ä½™å­—æ®µæ–¹ä¾¿æŸ¥è¯¢)
   - file_name (æ–‡ä»¶å)
   - file_path (æ–‡ä»¶è·¯å¾„, NASæˆ–OSS)
   - file_size (æ–‡ä»¶å¤§å°, bytes)
   - file_type (æ–‡ä»¶æ‰©å±•å)
   - file_url (å¯è®¿é—®URL, é¢„ç­¾åURL)
   - uploaded_by_id (ä¸Šä¼ äººID, å¤–é”® â†’ users)
   - uploaded_at (ä¸Šä¼ æ—¶é—´)
   - audit_status (å®¡æ ¸çŠ¶æ€: pending/approved/rejected)
   - audited_by_id (å®¡æ ¸äººID)
   - audited_at (å®¡æ ¸æ—¶é—´)
   - audit_notes (å®¡æ ¸å¤‡æ³¨)
   - archived (æ˜¯å¦å·²å½’æ¡£, default=False)
   - archive_path (å½’æ¡£è·¯å¾„)
   - archived_at (å½’æ¡£æ—¶é—´)
   - created_at, updated_at
   ```

**ç´¢å¼•**ï¼š
- `logistics_providers`: `provider_code` (unique), `provider_name`, `is_active`
- `document_center`: 
  - `business_type + business_id` (å¤åˆç´¢å¼•)
  - `business_no`
  - `uploaded_by_id`
  - `audit_status`
  - `archived`

---

### 3.2 åç«¯ - Models

#### ğŸ“‚ `backend/app/models/logistics/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `logistics_provider.py` | ğŸ†• æ–°å»º | ç‰©æµæœåŠ¡å•†æ¨¡å‹ |

**æ–°å»ºå†…å®¹**ï¼š
```python
"""
ç‰©æµæœåŠ¡å•†æ¨¡å‹ (LogisticsProvider)
ç”¨äºç®¡ç†ç‰©æµæœåŠ¡å•†ä¸»æ•°æ®ï¼ŒåŒºåˆ«äºå•†å“ä¾›åº”å•†
"""
from enum import Enum
from typing import Optional, List
from sqlalchemy import String, Boolean, ARRAY
from sqlalchemy.orm import Mapped, mapped_column
from app.extensions import db

class LogisticsServiceType(str, Enum):
    """ç‰©æµæœåŠ¡ç±»å‹"""
    DOMESTIC_TRUCKING = 'domestic_trucking'    # å›½å†…å¡è½¦è¿è¾“
    INTERNATIONAL_SEA = 'international_sea'    # å›½é™…æµ·è¿
    INTERNATIONAL_AIR = 'international_air'    # å›½é™…ç©ºè¿
    CUSTOMS_CLEARANCE = 'customs_clearance'    # æ¸…å…³æœåŠ¡
    DESTINATION_DELIVERY = 'destination_delivery'  # ç›®çš„å›½æ´¾é€

class PaymentMethodType(str, Enum):
    """ä»˜æ¬¾æ–¹å¼"""
    PREPAID = 'prepaid'      # é¢„ä»˜
    IMMEDIATE = 'immediate'  # å³ä»˜
    POSTPAID = 'postpaid'    # åä»˜

class SettlementCycle(str, Enum):
    """ç»“ç®—å‘¨æœŸ"""
    IMMEDIATE = 'immediate'  # å³æ—¶ç»“ç®—
    WEEKLY = 'weekly'        # å‘¨ç»“
    MONTHLY = 'monthly'      # æœˆç»“

class LogisticsProvider(db.Model):
    """ç‰©æµæœåŠ¡å•†è¡¨"""
    __tablename__ = "logistics_providers"
    
    # ... å­—æ®µå®šä¹‰ï¼ˆä¸è¿ç§»æ–‡ä»¶ä¸€è‡´ï¼‰
```

---

#### ğŸ“‚ `backend/app/models/document/`ï¼ˆæ–°å»ºç›®å½•ï¼‰

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `__init__.py` | ğŸ†• æ–°å»º | åˆå§‹åŒ–æ–‡ä»¶ |
| `document_center.py` | ğŸ†• æ–°å»º | å‡­è¯ç®¡ç†ä¸­å¿ƒæ¨¡å‹ |

**æ–°å»ºå†…å®¹**ï¼š
```python
"""
å‡­è¯ç®¡ç†ä¸­å¿ƒæ¨¡å‹ (DocumentCenter)
é€šç”¨çš„ä¸šåŠ¡å‡­è¯ç®¡ç†ï¼Œæ”¯æŒç‰©æµ/é‡‡è´­/æŠ¥å…³/ä»˜æ¬¾å››å¤§ç±»å‡­è¯
"""
from enum import Enum
from typing import Optional, TYPE_CHECKING
from sqlalchemy import String, Integer, BigInteger, Boolean, ForeignKey
from sqlalchemy.orm import Mapped, mapped_column, relationship
from app.extensions import db

class BusinessType(str, Enum):
    """ä¸šåŠ¡ç±»å‹"""
    LOGISTICS = 'logistics'      # ç‰©æµä¸šåŠ¡
    PURCHASE = 'purchase'        # é‡‡è´­ä¸šåŠ¡
    CUSTOMS = 'customs'          # æŠ¥å…³ä¸šåŠ¡
    PAYMENT = 'payment'          # ä»˜æ¬¾ä¸šåŠ¡

class DocumentCategory(str, Enum):
    """æ–‡æ¡£åˆ†ç±»"""
    SERVICE_VOUCHER = 'service_voucher'    # æœåŠ¡å‡­è¯
    PAYMENT_VOUCHER = 'payment_voucher'    # ä»˜æ¬¾å‡­è¯
    CONTRACT_VOUCHER = 'contract_voucher'  # åˆåŒå‡­è¯
    INVOICE_VOUCHER = 'invoice_voucher'    # å‘ç¥¨å‡­è¯
    CUSTOMS_VOUCHER = 'customs_voucher'    # æŠ¥å…³å‡­è¯

class AuditStatus(str, Enum):
    """å®¡æ ¸çŠ¶æ€"""
    PENDING = 'pending'      # å¾…å®¡æ ¸
    APPROVED = 'approved'    # å·²å®¡æ ¸
    REJECTED = 'rejected'    # å·²é©³å›

class DocumentCenter(db.Model):
    """å‡­è¯ç®¡ç†ä¸­å¿ƒè¡¨"""
    __tablename__ = "document_center"
    
    # ... å­—æ®µå®šä¹‰ï¼ˆä¸è¿ç§»æ–‡ä»¶ä¸€è‡´ï¼‰
```

---

### 3.3 åç«¯ - Schemas

#### ğŸ“‚ `backend/app/schemas/logistics/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `logistics_provider.py` | ğŸ†• æ–°å»º | ç‰©æµæœåŠ¡å•†åºåˆ—åŒ–Schema |

**æ–°å»ºå†…å®¹**ï¼š
```python
from apiflask import Schema
from apiflask.fields import String, Boolean, List as ListField, Integer, DateTime
from marshmallow import validates, ValidationError

class LogisticsProviderSchema(Schema):
    """ç‰©æµæœåŠ¡å•†è¾“å‡ºSchema"""
    id = Integer(dump_only=True)
    provider_name = String(required=True, metadata={'description': 'æœåŠ¡å•†åç§°', 'example': 'é¡ºä¸°é€Ÿè¿'})
    provider_code = String(required=True, metadata={'description': 'æœåŠ¡å•†ç¼–ç ', 'example': 'SF001'})
    service_type = String(metadata={'description': 'æœåŠ¡ç±»å‹'})
    # ... å…¶ä»–å­—æ®µ

class LogisticsProviderCreateSchema(Schema):
    """ç‰©æµæœåŠ¡å•†åˆ›å»ºSchema"""
    provider_name = String(required=True)
    provider_code = String(required=True)
    # ...

class LogisticsProviderUpdateSchema(Schema):
    """ç‰©æµæœåŠ¡å•†æ›´æ–°Schema"""
    provider_name = String()
    # ...
```

---

#### ğŸ“‚ `backend/app/schemas/document/`ï¼ˆæ–°å»ºç›®å½•ï¼‰

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `__init__.py` | ğŸ†• æ–°å»º | åˆå§‹åŒ–æ–‡ä»¶ |
| `document.py` | ğŸ†• æ–°å»º | å‡­è¯ç®¡ç†Schema |

---

### 3.4 åç«¯ - Services

#### ğŸ“‚ `backend/app/services/logistics/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `logistics_provider_service.py` | ğŸ†• æ–°å»º | ç‰©æµæœåŠ¡å•†ä¸šåŠ¡é€»è¾‘ |

**æ–°å»ºå†…å®¹**ï¼š
```python
"""
ç‰©æµæœåŠ¡å•†æœåŠ¡å±‚
å¤„ç†ç‰©æµæœåŠ¡å•†çš„CRUDä¸šåŠ¡é€»è¾‘
"""
from app.models.logistics.logistics_provider import LogisticsProvider
from app.extensions import db
from app.errors import BusinessError

class LogisticsProviderService:
    """ç‰©æµæœåŠ¡å•†ä¸šåŠ¡é€»è¾‘ç±»"""
    
    @staticmethod
    def create_provider(data: dict, created_by: int):
        """åˆ›å»ºç‰©æµæœåŠ¡å•†"""
        # æ£€æŸ¥ç¼–ç æ˜¯å¦é‡å¤
        if LogisticsProvider.query.filter_by(provider_code=data['provider_code']).first():
            raise BusinessError('æœåŠ¡å•†ç¼–ç å·²å­˜åœ¨', code=400)
        
        provider = LogisticsProvider(**data)
        db.session.add(provider)
        db.session.commit()
        return provider
    
    @staticmethod
    def get_provider_by_id(provider_id: int):
        """æ ¹æ®IDè·å–æœåŠ¡å•†"""
        return LogisticsProvider.query.get(provider_id)
    
    # ... å…¶ä»–æ–¹æ³•
```

---

#### ğŸ“‚ `backend/app/services/document/`ï¼ˆæ–°å»ºç›®å½•ï¼‰

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `__init__.py` | ğŸ†• æ–°å»º | åˆå§‹åŒ–æ–‡ä»¶ |
| `document_service.py` | ğŸ†• æ–°å»º | å‡­è¯ç®¡ç†ä¸šåŠ¡é€»è¾‘ |
| `archive_service.py` | ğŸ†• æ–°å»º | å½’æ¡£æœåŠ¡ï¼ˆé˜¶æ®µ3å®ç°ï¼‰ |

---

### 3.5 åç«¯ - API Routes

#### ğŸ“‚ `backend/app/api/logistics/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `logistics_provider_routes.py` | ğŸ†• æ–°å»º | ç‰©æµæœåŠ¡å•†APIè·¯ç”± |

**æ–°å»ºå†…å®¹**ï¼š
```python
"""ç‰©æµæœåŠ¡å•†APIè·¯ç”±"""
from apiflask import APIBlueprint
from apiflask.views import MethodView
from app.security import auth
from app.decorators import permission_required
from app.schemas.logistics.logistics_provider import (
    LogisticsProviderSchema,
    LogisticsProviderCreateSchema,
    LogisticsProviderUpdateSchema
)
from app.services.logistics.logistics_provider_service import LogisticsProviderService

logistics_provider_bp = APIBlueprint(
    'logistics_providers', 
    __name__, 
    url_prefix='/logistics-providers', 
    tag='ç‰©æµæœåŠ¡å•†ç®¡ç†'
)

class LogisticsProviderListAPI(MethodView):
    """ç‰©æµæœåŠ¡å•†åˆ—è¡¨API"""
    decorators = [logistics_provider_bp.auth_required(auth)]
    
    @logistics_provider_bp.doc(summary='è·å–ç‰©æµæœåŠ¡å•†åˆ—è¡¨')
    @logistics_provider_bp.output(LogisticsProviderSchema(many=True))
    def get(self):
        """è·å–åˆ—è¡¨"""
        # ...
    
    @logistics_provider_bp.doc(summary='åˆ›å»ºç‰©æµæœåŠ¡å•†')
    @logistics_provider_bp.input(LogisticsProviderCreateSchema, arg_name='data')
    @logistics_provider_bp.output(LogisticsProviderSchema, status_code=201)
    @permission_required('logistics:provider:create')
    def post(self, data):
        """åˆ›å»ºæœåŠ¡å•†"""
        # ...

# ... å…¶ä»–API
```

---

#### ğŸ“‚ `backend/app/api/document/`ï¼ˆæ–°å»ºç›®å½•ï¼‰

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `__init__.py` | ğŸ†• æ–°å»º | åˆå§‹åŒ–æ–‡ä»¶ |
| `document_routes.py` | ğŸ†• æ–°å»º | å‡­è¯ç®¡ç†APIè·¯ç”± |

---

### 3.6 åç«¯ - æ³¨å†ŒBlueprint

#### ğŸ“‚ `backend/app/api/__init__.py`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `__init__.py` | ğŸ”§ è°ƒæ•´ | æ³¨å†Œæ–°çš„Blueprint |

**è°ƒæ•´å†…å®¹**ï¼š
```python
# ç°æœ‰ä»£ç 
from app.api.logistics.routes import logistics_bp

# æ–°å¢å¯¼å…¥
from app.api.logistics.logistics_provider_routes import logistics_provider_bp
from app.api.document.document_routes import document_bp

def register_blueprints(api_v1):
    """æ³¨å†Œæ‰€æœ‰Blueprint"""
    # ç°æœ‰
    api_v1.register_blueprint(logistics_bp)
    
    # æ–°å¢
    api_v1.register_blueprint(logistics_provider_bp)  # ç‰©æµæœåŠ¡å•†
    api_v1.register_blueprint(document_bp)            # å‡­è¯ç®¡ç†
    # ...
```

---

### 3.7 å‰ç«¯ - APIå°è£…

#### ğŸ“‚ `frontend/apps/web-antd/src/api/logistics/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `logistics-provider.ts` | ğŸ†• æ–°å»º | ç‰©æµæœåŠ¡å•†APIå°è£… |

**æ–°å»ºå†…å®¹**ï¼š
```typescript
import { request } from '@vben/request';

export interface LogisticsProvider {
  id: number;
  provider_name: string;
  provider_code: string;
  service_type: string;
  payment_method: string;
  settlement_cycle: string;
  contact_name?: string;
  contact_phone?: string;
  bank_name?: string;
  bank_account?: string;
  is_active: boolean;
  created_at: string;
}

export interface LogisticsProviderCreate {
  provider_name: string;
  provider_code: string;
  service_type: string;
  payment_method: string;
  settlement_cycle: string;
  // ...
}

/**
 * è·å–ç‰©æµæœåŠ¡å•†åˆ—è¡¨
 */
export function getLogisticsProviders(params?: any) {
  return request<LogisticsProvider[]>({
    url: '/api/v1/logistics-providers',
    method: 'GET',
    params,
  });
}

/**
 * åˆ›å»ºç‰©æµæœåŠ¡å•†
 */
export function createLogisticsProvider(data: LogisticsProviderCreate) {
  return request<LogisticsProvider>({
    url: '/api/v1/logistics-providers',
    method: 'POST',
    data,
  });
}

// ... å…¶ä»–API
```

---

#### ğŸ“‚ `frontend/apps/web-antd/src/api/document/`ï¼ˆæ–°å»ºç›®å½•ï¼‰

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `document.ts` | ğŸ†• æ–°å»º | å‡­è¯ç®¡ç†APIå°è£… |

---

### 3.8 å‰ç«¯ - é¡µé¢ç»„ä»¶

#### ğŸ“‚ `frontend/apps/web-antd/src/views/logistics/provider/`ï¼ˆæ–°å»ºç›®å½•ï¼‰

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `index.vue` | ğŸ†• æ–°å»º | ç‰©æµæœåŠ¡å•†åˆ—è¡¨é¡µ |
| `components/ProviderFormModal.vue` | ğŸ†• æ–°å»º | æœåŠ¡å•†åˆ›å»º/ç¼–è¾‘å¼¹çª— |

**æ–°å»ºå†…å®¹**ï¼ˆ`index.vue`ï¼‰ï¼š
```vue
<script setup lang="ts">
/**
 * ç‰©æµæœåŠ¡å•†ç®¡ç†é¡µé¢
 */
import { useVbenVxeGrid, type VxeGridProps } from '#/adapter/vxe-table';
import { 
  getLogisticsProviders, 
  deleteLogisticsProvider 
} from '#/api/logistics/logistics-provider';
import { onMounted, ref } from 'vue';
import ProviderFormModal from './components/ProviderFormModal.vue';

// Gridé…ç½®
const gridOptions: VxeGridProps = {
  columns: [
    { field: 'id', title: 'ID', width: 80 },
    { field: 'provider_code', title: 'æœåŠ¡å•†ç¼–ç ', width: 120 },
    { field: 'provider_name', title: 'æœåŠ¡å•†åç§°', minWidth: 150 },
    { field: 'service_type', title: 'æœåŠ¡ç±»å‹', width: 120 },
    { field: 'payment_method', title: 'ä»˜æ¬¾æ–¹å¼', width: 100 },
    { field: 'settlement_cycle', title: 'ç»“ç®—å‘¨æœŸ', width: 100 },
    { field: 'contact_name', title: 'è”ç³»äºº', width: 100 },
    { field: 'contact_phone', title: 'è”ç³»ç”µè¯', width: 130 },
    { 
      field: 'is_active', 
      title: 'çŠ¶æ€', 
      width: 80,
      slots: { default: 'is_active_default' }
    },
    { 
      title: 'æ“ä½œ', 
      width: 150, 
      fixed: 'right',
      slots: { default: 'action_default' }
    },
  ],
  data: [],
  pagerConfig: { enabled: true },
  toolbarConfig: {
    refresh: { code: 'query' },
    custom: true,
  },
};

const [Grid, gridApi] = useVbenVxeGrid({ gridOptions });

// æ•°æ®åŠ è½½
async function loadData() {
  try {
    gridApi.setLoading(true);
    const res = await getLogisticsProviders();
    gridApi.setGridOptions({ data: res });
  } catch (e) {
    console.error(e);
  } finally {
    gridApi.setLoading(false);
  }
}

onMounted(() => {
  loadData();
});

// æ–°å»º/ç¼–è¾‘
const showModal = ref(false);
const editingId = ref<number | null>(null);

function handleCreate() {
  editingId.value = null;
  showModal.value = true;
}

function handleEdit(row: any) {
  editingId.value = row.id;
  showModal.value = true;
}

function handleModalClose() {
  showModal.value = false;
  loadData();
}
</script>

<template>
  <div class="p-4">
    <Grid>
      <!-- å·¥å…·æ  -->
      <template #toolbar_buttons>
        <a-button type="primary" @click="handleCreate">
          æ–°å»ºæœåŠ¡å•†
        </a-button>
      </template>
      
      <!-- çŠ¶æ€åˆ— -->
      <template #is_active_default="{ row }">
        <a-tag :color="row.is_active ? 'green' : 'red'">
          {{ row.is_active ? 'å¯ç”¨' : 'åœç”¨' }}
        </a-tag>
      </template>
      
      <!-- æ“ä½œåˆ— -->
      <template #action_default="{ row }">
        <a-space>
          <a-button type="link" size="small" @click="handleEdit(row)">
            ç¼–è¾‘
          </a-button>
          <a-popconfirm title="ç¡®è®¤åˆ é™¤ï¼Ÿ" @confirm="handleDelete(row.id)">
            <a-button type="link" danger size="small">åˆ é™¤</a-button>
          </a-popconfirm>
        </a-space>
      </template>
    </Grid>
    
    <!-- è¡¨å•å¼¹çª— -->
    <ProviderFormModal 
      v-if="showModal"
      :visible="showModal"
      :provider-id="editingId"
      @close="handleModalClose"
    />
  </div>
</template>
```

---

### 3.9 å‰ç«¯ - è·¯ç”±é…ç½®

#### ğŸ“‚ `frontend/apps/web-antd/src/router/routes/modules/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `logistics.ts` | ğŸ”§ è°ƒæ•´ | å¢åŠ ç‰©æµæœåŠ¡å•†è·¯ç”± |

**è°ƒæ•´å†…å®¹**ï¼š
```typescript
// ç°æœ‰ä»£ç 
import type { RouteRecordRaw } from 'vue-router';

const routes: RouteRecordRaw[] = [
  {
    path: '/logistics',
    name: 'Logistics',
    component: () => import('#/layouts/index.vue'),
    meta: { title: 'ç‰©æµç®¡ç†', icon: 'mdi:truck' },
    children: [
      // ç°æœ‰ï¼šå‘è´§å•ç®¡ç†
      {
        path: 'shipment',
        name: 'LogisticsShipment',
        component: () => import('#/views/logistics/shipment/index.vue'),
        meta: { title: 'å‘è´§å•ç®¡ç†' },
      },
      // æ–°å¢ï¼šç‰©æµæœåŠ¡å•†ç®¡ç†
      {
        path: 'provider',
        name: 'LogisticsProvider',
        component: () => import('#/views/logistics/provider/index.vue'),
        meta: { 
          title: 'ç‰©æµæœåŠ¡å•†ç®¡ç†',
          authority: 'logistics:provider:view'
        },
      },
    ],
  },
];

export default routes;
```

---

## å››ã€é˜¶æ®µ2ï¼šç‰©æµæœåŠ¡æ˜ç»†å…³è”ï¼ˆ2-3å¤©ï¼‰

### 4.1 åç«¯ - æ•°æ®åº“è¿ç§»

#### ğŸ“‚ `backend/migrations/versions/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `[timestamp]_add_shipment_logistics_services.py` | ğŸ†• æ–°å»º | åˆ›å»ºå‘è´§å•ç‰©æµæœåŠ¡æ˜ç»†è¡¨ |

**è¿ç§»å†…å®¹**ï¼š
```python
"""åˆ›å»ºå‘è´§å•ç‰©æµæœåŠ¡æ˜ç»†è¡¨"""
def upgrade():
    op.create_table(
        'shipment_logistics_services',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('shipment_id', sa.Integer(), nullable=False),
        sa.Column('logistics_provider_id', sa.Integer(), nullable=False),
        sa.Column('service_type', sa.String(50), nullable=False),
        sa.Column('service_description', sa.Text()),
        sa.Column('estimated_amount', sa.DECIMAL(18, 2)),
        sa.Column('actual_amount', sa.DECIMAL(18, 2)),
        sa.Column('currency', sa.String(10), default='CNY'),
        sa.Column('payment_method', sa.String(20)),
        sa.Column('service_voucher_id', sa.Integer()),  # å¤–é”® â†’ document_center
        sa.Column('payment_voucher_id', sa.Integer()),  # å¤–é”® â†’ document_center
        sa.Column('status', sa.String(20), default='pending'),  # pending/confirmed/reconciled/paid
        sa.Column('confirmed_at', sa.DateTime()),
        sa.Column('reconciled_at', sa.DateTime()),
        sa.Column('paid_at', sa.DateTime()),
        sa.Column('notes', sa.Text()),
        sa.Column('created_at', sa.DateTime(), server_default=sa.func.now()),
        sa.Column('updated_at', sa.DateTime(), onupdate=sa.func.now()),
        sa.PrimaryKeyConstraint('id'),
        sa.ForeignKeyConstraint(['shipment_id'], ['shipment_orders.id'], ondelete='CASCADE'),
        sa.ForeignKeyConstraint(['logistics_provider_id'], ['logistics_providers.id']),
        sa.ForeignKeyConstraint(['service_voucher_id'], ['document_center.id']),
        sa.ForeignKeyConstraint(['payment_voucher_id'], ['document_center.id']),
    )
    
    # ç´¢å¼•
    op.create_index('idx_sls_shipment_id', 'shipment_logistics_services', ['shipment_id'])
    op.create_index('idx_sls_provider_id', 'shipment_logistics_services', ['logistics_provider_id'])
    op.create_index('idx_sls_status', 'shipment_logistics_services', ['status'])
```

---

### 4.2 åç«¯ - Models

#### ğŸ“‚ `backend/app/models/logistics/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `shipment_logistics_service.py` | ğŸ†• æ–°å»º | å‘è´§å•ç‰©æµæœåŠ¡æ˜ç»†æ¨¡å‹ |
| `shipment.py` | ğŸ”§ è°ƒæ•´ | å¢åŠ relationship |

**æ–°å»ºæ–‡ä»¶å†…å®¹**ï¼ˆ`shipment_logistics_service.py`ï¼‰ï¼š
```python
"""
å‘è´§å•ç‰©æµæœåŠ¡æ˜ç»†æ¨¡å‹ (ShipmentLogisticsService)
è®°å½•ä¸€ä¸ªå‘è´§å•å¯¹åº”çš„å¤šä¸ªç‰©æµæœåŠ¡å•†åŠå…¶è´¹ç”¨

ã€é‡è¦ã€‘ï¼š
- è´¹ç”¨é‡‡ç”¨æ‰‹å·¥å½•å…¥æ–¹å¼ï¼ˆç‰©æµæœåŠ¡å•†æ— APIæ¥å£ï¼‰
- estimated_amount: é¢„ä¼°è´¹ç”¨ï¼ˆå‘è´§å‰ç”±è·Ÿå•äººå‘˜æ ¹æ®æŠ¥ä»·å½•å…¥ï¼‰
- actual_amount: å®é™…è´¹ç”¨ï¼ˆæ”¶åˆ°è´¦å•åç”±è´¢åŠ¡äººå‘˜å½•å…¥ï¼‰
"""
from enum import Enum
from typing import Optional, TYPE_CHECKING
from decimal import Decimal
from sqlalchemy import String, Integer, ForeignKey, DECIMAL, DateTime, Text, func
from sqlalchemy.orm import Mapped, mapped_column, relationship
from app.extensions import db

if TYPE_CHECKING:
    from app.models.logistics.shipment import ShipmentOrder
    from app.models.logistics.logistics_provider import LogisticsProvider
    from app.models.document.document_center import DocumentCenter

class ServiceStatus(str, Enum):
    """æœåŠ¡çŠ¶æ€"""
    PENDING = 'pending'          # å¾…ç¡®è®¤
    CONFIRMED = 'confirmed'      # å·²ç¡®è®¤
    RECONCILED = 'reconciled'    # å·²å¯¹è´¦
    PAID = 'paid'                # å·²ä»˜æ¬¾

class ShipmentLogisticsService(db.Model):
    """å‘è´§å•ç‰©æµæœåŠ¡æ˜ç»†è¡¨"""
    __tablename__ = "shipment_logistics_services"
    
    id: Mapped[int] = mapped_column(primary_key=True)
    shipment_id: Mapped[int] = mapped_column(ForeignKey("shipment_orders.id", ondelete="CASCADE"))
    logistics_provider_id: Mapped[int] = mapped_column(ForeignKey("logistics_providers.id"))
    
    # æœåŠ¡ä¿¡æ¯
    service_type: Mapped[str] = mapped_column(String(50), comment='æœåŠ¡ç±»å‹')
    service_description: Mapped[Optional[str]] = mapped_column(Text, comment='æœåŠ¡æè¿°')
    
    # è´¹ç”¨ä¿¡æ¯
    estimated_amount: Mapped[Optional[Decimal]] = mapped_column(DECIMAL(18, 2), comment='é¢„ä¼°è´¹ç”¨')
    actual_amount: Mapped[Optional[Decimal]] = mapped_column(DECIMAL(18, 2), comment='å®é™…è´¹ç”¨')
    currency: Mapped[str] = mapped_column(String(10), default='CNY', comment='å¸ç§')
    payment_method: Mapped[Optional[str]] = mapped_column(String(20), comment='ä»˜æ¬¾æ–¹å¼')
    
    # å‡­è¯å…³è”
    service_voucher_id: Mapped[Optional[int]] = mapped_column(ForeignKey("document_center.id"), comment='æœåŠ¡å‡­è¯ID')
    payment_voucher_id: Mapped[Optional[int]] = mapped_column(ForeignKey("document_center.id"), comment='ä»˜æ¬¾å‡­è¯ID')
    
    # çŠ¶æ€ä¸æ—¶é—´
    status: Mapped[str] = mapped_column(String(20), default=ServiceStatus.PENDING.value)
    confirmed_at: Mapped[Optional[DateTime]] = mapped_column(DateTime, comment='ç¡®è®¤æ—¶é—´')
    reconciled_at: Mapped[Optional[DateTime]] = mapped_column(DateTime, comment='å¯¹è´¦æ—¶é—´')
    paid_at: Mapped[Optional[DateTime]] = mapped_column(DateTime, comment='ä»˜æ¬¾æ—¶é—´')
    
    # å¤‡æ³¨
    notes: Mapped[Optional[str]] = mapped_column(Text, comment='å¤‡æ³¨')
    
    # å®¡è®¡å­—æ®µ
    created_at: Mapped[DateTime] = mapped_column(DateTime, server_default=func.now())
    updated_at: Mapped[Optional[DateTime]] = mapped_column(DateTime, onupdate=func.now())
    
    # Relationships
    shipment: Mapped["ShipmentOrder"] = relationship("ShipmentOrder", back_populates="logistics_services")
    logistics_provider: Mapped["LogisticsProvider"] = relationship("LogisticsProvider")
    service_voucher: Mapped[Optional["DocumentCenter"]] = relationship(
        "DocumentCenter", 
        foreign_keys=[service_voucher_id]
    )
    payment_voucher: Mapped[Optional["DocumentCenter"]] = relationship(
        "DocumentCenter", 
        foreign_keys=[payment_voucher_id]
    )
```

**è°ƒæ•´æ–‡ä»¶å†…å®¹**ï¼ˆ`shipment.py`ï¼‰ï¼š
```python
# åœ¨ ShipmentOrder ç±»ä¸­æ–°å¢ relationship
class ShipmentOrder(db.Model):
    # ... ç°æœ‰ä»£ç  ...
    
    # æ–°å¢ï¼šç‰©æµæœåŠ¡æ˜ç»†å…³ç³»
    logistics_services: Mapped[List["ShipmentLogisticsService"]] = relationship(
        "ShipmentLogisticsService",
        back_populates="shipment",
        cascade="all, delete-orphan",
        order_by="ShipmentLogisticsService.id"
    )
```

---

### 4.3 åç«¯ - Schemas

#### ğŸ“‚ `backend/app/schemas/logistics/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `shipment_logistics_service.py` | ğŸ†• æ–°å»º | ç‰©æµæœåŠ¡æ˜ç»†Schema |

---

### 4.4 åç«¯ - Services

#### ğŸ“‚ `backend/app/services/logistics/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `shipment_logistics_service.py` | ğŸ†• æ–°å»º | ç‰©æµæœåŠ¡æ˜ç»†ä¸šåŠ¡é€»è¾‘ |

**æ–°å»ºå†…å®¹**ï¼š
```python
"""
å‘è´§å•ç‰©æµæœåŠ¡æ˜ç»†æœåŠ¡å±‚
å¤„ç†ç‰©æµæœåŠ¡çš„æ·»åŠ ã€æ›´æ–°ã€ç¡®è®¤ã€å¯¹è´¦ç­‰ä¸šåŠ¡é€»è¾‘
"""
from typing import List
from decimal import Decimal
from datetime import datetime
from app.models.logistics.shipment_logistics_service import ShipmentLogisticsService
from app.models.logistics.shipment import ShipmentOrder
from app.extensions import db
from app.errors import BusinessError

class ShipmentLogisticsServiceService:
    """ç‰©æµæœåŠ¡æ˜ç»†ä¸šåŠ¡é€»è¾‘ç±»"""
    
    @staticmethod
    def add_service(shipment_id: int, data: dict):
        """ä¸ºå‘è´§å•æ·»åŠ ç‰©æµæœåŠ¡"""
        # éªŒè¯å‘è´§å•å­˜åœ¨
        shipment = ShipmentOrder.query.get(shipment_id)
        if not shipment:
            raise BusinessError('å‘è´§å•ä¸å­˜åœ¨', code=404)
        
        # åˆ›å»ºç‰©æµæœåŠ¡
        service = ShipmentLogisticsService(
            shipment_id=shipment_id,
            **data
        )
        db.session.add(service)
        db.session.commit()
        return service
    
    @staticmethod
    def get_services_by_shipment(shipment_id: int) -> List[ShipmentLogisticsService]:
        """è·å–å‘è´§å•çš„æ‰€æœ‰ç‰©æµæœåŠ¡"""
        return ShipmentLogisticsService.query.filter_by(shipment_id=shipment_id).all()
    
    @staticmethod
    def calculate_total_cost(shipment_id: int) -> Decimal:
        """è®¡ç®—å‘è´§å•çš„ç‰©æµæ€»è´¹ç”¨"""
        services = ShipmentLogisticsServiceService.get_services_by_shipment(shipment_id)
        total = sum(s.actual_amount or s.estimated_amount or 0 for s in services)
        return Decimal(total)
    
    @staticmethod
    def confirm_service(service_id: int):
        """ç¡®è®¤ç‰©æµæœåŠ¡"""
        service = ShipmentLogisticsService.query.get(service_id)
        if not service:
            raise BusinessError('ç‰©æµæœåŠ¡ä¸å­˜åœ¨', code=404)
        
        service.status = 'confirmed'
        service.confirmed_at = datetime.now()
        db.session.commit()
        return service
    
    # ... å…¶ä»–æ–¹æ³•
```

---

### 4.5 åç«¯ - API Routes

#### ğŸ“‚ `backend/app/api/logistics/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `shipment_logistics_service_routes.py` | ğŸ†• æ–°å»º | ç‰©æµæœåŠ¡æ˜ç»†APIè·¯ç”± |

**æ–°å»ºå†…å®¹**ï¼š
```python
"""å‘è´§å•ç‰©æµæœåŠ¡æ˜ç»†APIè·¯ç”±"""
from apiflask import APIBlueprint
from apiflask.views import MethodView
from app.security import auth
from app.schemas.logistics.shipment_logistics_service import (
    ShipmentLogisticsServiceSchema,
    ShipmentLogisticsServiceCreateSchema
)
from app.services.logistics.shipment_logistics_service import ShipmentLogisticsServiceService

shipment_logistics_bp = APIBlueprint(
    'shipment_logistics', 
    __name__, 
    url_prefix='/shipments/<int:shipment_id>/logistics-services',
    tag='å‘è´§å•ç‰©æµæœåŠ¡'
)

class ShipmentLogisticsServiceListAPI(MethodView):
    """å‘è´§å•ç‰©æµæœåŠ¡åˆ—è¡¨API"""
    decorators = [shipment_logistics_bp.auth_required(auth)]
    
    @shipment_logistics_bp.doc(summary='è·å–å‘è´§å•çš„ç‰©æµæœåŠ¡åˆ—è¡¨')
    @shipment_logistics_bp.output(ShipmentLogisticsServiceSchema(many=True))
    def get(self, shipment_id):
        """è·å–ç‰©æµæœåŠ¡åˆ—è¡¨"""
        services = ShipmentLogisticsServiceService.get_services_by_shipment(shipment_id)
        return {'data': services}
    
    @shipment_logistics_bp.doc(summary='ä¸ºå‘è´§å•æ·»åŠ ç‰©æµæœåŠ¡')
    @shipment_logistics_bp.input(ShipmentLogisticsServiceCreateSchema, arg_name='data')
    @shipment_logistics_bp.output(ShipmentLogisticsServiceSchema, status_code=201)
    def post(self, shipment_id, data):
        """æ·»åŠ ç‰©æµæœåŠ¡"""
        service = ShipmentLogisticsServiceService.add_service(shipment_id, data)
        return {'data': service}

# æ³¨å†Œè·¯ç”±
shipment_logistics_bp.add_url_rule('', view_func=ShipmentLogisticsServiceListAPI.as_view('list'))
```

---

### 4.6 å‰ç«¯ - APIå°è£…

#### ğŸ“‚ `frontend/apps/web-antd/src/api/logistics/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `shipment-logistics-service.ts` | ğŸ†• æ–°å»º | ç‰©æµæœåŠ¡æ˜ç»†APIå°è£… |

**æ–°å»ºå†…å®¹**ï¼š
```typescript
import { request } from '@vben/request';

export interface ShipmentLogisticsService {
  id: number;
  shipment_id: number;
  logistics_provider_id: number;
  logistics_provider_name: string;
  service_type: string;
  service_description?: string;
  estimated_amount?: number;
  actual_amount?: number;
  currency: string;
  payment_method?: string;
  status: string;
  service_voucher_id?: number;
  payment_voucher_id?: number;
  created_at: string;
}

/**
 * è·å–å‘è´§å•çš„ç‰©æµæœåŠ¡åˆ—è¡¨
 */
export function getShipmentLogisticsServices(shipmentId: number) {
  return request<ShipmentLogisticsService[]>({
    url: `/api/v1/shipments/${shipmentId}/logistics-services`,
    method: 'GET',
  });
}

/**
 * ä¸ºå‘è´§å•æ·»åŠ ç‰©æµæœåŠ¡
 */
export function addShipmentLogisticsService(shipmentId: number, data: any) {
  return request<ShipmentLogisticsService>({
    url: `/api/v1/shipments/${shipmentId}/logistics-services`,
    method: 'POST',
    data,
  });
}

/**
 * åˆ é™¤ç‰©æµæœåŠ¡
 */
export function deleteShipmentLogisticsService(shipmentId: number, serviceId: number) {
  return request({
    url: `/api/v1/shipments/${shipmentId}/logistics-services/${serviceId}`,
    method: 'DELETE',
  });
}

/**
 * æ›´æ–°ç‰©æµæœåŠ¡
 */
export function updateShipmentLogisticsService(shipmentId: number, serviceId: number, data: any) {
  return request<ShipmentLogisticsService>({
    url: `/api/v1/shipments/${shipmentId}/logistics-services/${serviceId}`,
    method: 'PUT',
    data,
  });
}
```

---

### 4.7 å‰ç«¯ - ç»„ä»¶å¼€å‘

#### ğŸ“‚ `frontend/apps/web-antd/src/views/logistics/shipment/components/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `LogisticsServicesPanel.vue` | ğŸ†• æ–°å»º | ç‰©æµæœåŠ¡Tabé¢æ¿ |
| `LogisticsServiceFormModal.vue` | ğŸ†• æ–°å»º | æ·»åŠ ç‰©æµæœåŠ¡å¼¹çª— |
| `FinanceTab.vue` | ğŸ”§ è°ƒæ•´ | è°ƒæ•´ä¸ºä»ç‰©æµæœåŠ¡æ˜ç»†æ±‡æ€»è´¹ç”¨ |

**æ–°å»ºæ–‡ä»¶**ï¼ˆ`LogisticsServicesPanel.vue`ï¼‰ï¼š
```vue
<script setup lang="ts">
/**
 * å‘è´§å•è¯¦æƒ… - ç‰©æµæœåŠ¡Tab
 * å±•ç¤ºç‰©æµæœåŠ¡æ˜ç»†åˆ—è¡¨ï¼Œæ”¯æŒæ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤ã€ä¸Šä¼ å‡­è¯
 */
import { useVbenVxeGrid, type VxeGridProps } from '#/adapter/vxe-table';
import { 
  getShipmentLogisticsServices, 
  deleteShipmentLogisticsService 
} from '#/api/logistics/shipment-logistics-service';
import { onMounted, ref, computed } from 'vue';
import { message } from 'ant-design-vue';
import LogisticsServiceFormModal from './LogisticsServiceFormModal.vue';

const props = defineProps<{
  shipmentId: number;
}>();

// Gridé…ç½®
const gridOptions: VxeGridProps = {
  columns: [
    { field: 'id', title: 'ID', width: 60 },
    { field: 'logistics_provider_name', title: 'ç‰©æµæœåŠ¡å•†', minWidth: 150 },
    { field: 'service_type', title: 'æœåŠ¡ç±»å‹', width: 120 },
    { field: 'service_description', title: 'æœåŠ¡æè¿°', minWidth: 200 },
    { 
      field: 'estimated_amount', 
      title: 'é¢„ä¼°è´¹ç”¨', 
      width: 110,
      slots: { default: 'amount_default' }
    },
    { 
      field: 'actual_amount', 
      title: 'å®é™…è´¹ç”¨', 
      width: 110,
      slots: { default: 'amount_default' }
    },
    { field: 'payment_method', title: 'ä»˜æ¬¾æ–¹å¼', width: 100 },
    { 
      field: 'status', 
      title: 'çŠ¶æ€', 
      width: 90,
      slots: { default: 'status_default' }
    },
    { 
      title: 'å‡­è¯', 
      width: 150,
      slots: { default: 'voucher_default' }
    },
    { 
      title: 'æ“ä½œ', 
      width: 120, 
      fixed: 'right',
      slots: { default: 'action_default' }
    },
  ],
  data: [],
  toolbarConfig: {
    refresh: { code: 'query' },
  },
};

const [Grid, gridApi] = useVbenVxeGrid({ 
  gridOptions,
  gridEvents: {
    toolbarToolClick: (params) => {
      if (params.code === 'query') loadData();
    }
  }
});

// åŠ è½½æ•°æ®
async function loadData() {
  try {
    gridApi.setLoading(true);
    const res = await getShipmentLogisticsServices(props.shipmentId);
    gridApi.setGridOptions({ data: res });
  } catch (e: any) {
    message.error('åŠ è½½ç‰©æµæœåŠ¡å¤±è´¥');
  } finally {
    gridApi.setLoading(false);
  }
}

onMounted(() => {
  loadData();
});

// æ–°å»º/ç¼–è¾‘
const showModal = ref(false);
const editingId = ref<number | null>(null);

function handleAdd() {
  editingId.value = null;
  showModal.value = true;
}

function handleEdit(row: any) {
  editingId.value = row.id;
  showModal.value = true;
}

function handleModalClose() {
  showModal.value = false;
  loadData();
}

// è®¡ç®—æ€»è´¹ç”¨
const totalCost = computed(() => {
  const data = gridApi.getTableData().fullData;
  return data.reduce((sum, item) => {
    return sum + (item.actual_amount || item.estimated_amount || 0);
  }, 0);
});

// è¾…åŠ©å‡½æ•°ï¼šçŠ¶æ€é¢œè‰²æ˜ å°„
function getStatusColor(status: string): string {
  const colorMap: Record<string, string> = {
    pending: 'default',
    confirmed: 'blue',
    reconciled: 'orange',
    paid: 'green',
  };
  return colorMap[status] || 'default';
}

// è¾…åŠ©å‡½æ•°ï¼šçŠ¶æ€æ–‡æœ¬æ˜ å°„
function getStatusText(status: string): string {
  const textMap: Record<string, string> = {
    pending: 'å¾…ç¡®è®¤',
    confirmed: 'å·²ç¡®è®¤',
    reconciled: 'å·²å¯¹è´¦',
    paid: 'å·²ä»˜æ¬¾',
  };
  return textMap[status] || status;
}

// è¾…åŠ©å‡½æ•°ï¼šæŸ¥çœ‹å‡­è¯
function viewVoucher(voucherId: number) {
  // TODO: å®ç°å‡­è¯é¢„è§ˆé€»è¾‘
  console.log('æŸ¥çœ‹å‡­è¯:', voucherId);
}

// è¾…åŠ©å‡½æ•°ï¼šåˆ é™¤ç‰©æµæœåŠ¡
async function handleDelete(id: number) {
  try {
    await deleteShipmentLogisticsService(props.shipmentId, id);
    message.success('åˆ é™¤æˆåŠŸ');
    loadData();
  } catch (e: any) {
    message.error('åˆ é™¤å¤±è´¥');
  }
}
</script>

<template>
  <div>
    <!-- å·¥å…·æ  -->
    <div class="mb-4 flex justify-between items-center">
      <a-button type="primary" @click="handleAdd">
        æ·»åŠ ç‰©æµæœåŠ¡
      </a-button>
      <a-statistic 
        title="ç‰©æµæ€»è´¹ç”¨" 
        :value="totalCost" 
        :precision="2" 
        prefix="Â¥"
        class="text-right"
      />
    </div>
    
    <!-- è¡¨æ ¼ -->
    <Grid>
      <!-- é‡‘é¢åˆ— -->
      <template #amount_default="{ row, column }">
        <span v-if="row[column.field]">
          Â¥{{ row[column.field].toLocaleString('zh-CN', { minimumFractionDigits: 2 }) }}
        </span>
        <span v-else class="text-gray-400">-</span>
      </template>
      
      <!-- çŠ¶æ€åˆ— -->
      <template #status_default="{ row }">
        <a-tag :color="getStatusColor(row.status)">
          {{ getStatusText(row.status) }}
        </a-tag>
      </template>
      
      <!-- å‡­è¯åˆ— -->
      <template #voucher_default="{ row }">
        <a-space direction="vertical" size="small">
          <a-button 
            v-if="row.service_voucher_id" 
            type="link" 
            size="small"
            @click="viewVoucher(row.service_voucher_id)"
          >
            æŸ¥çœ‹æœåŠ¡å‡­è¯
          </a-button>
          <a-button 
            v-if="row.payment_voucher_id" 
            type="link" 
            size="small"
            @click="viewVoucher(row.payment_voucher_id)"
          >
            æŸ¥çœ‹ä»˜æ¬¾å‡­è¯
          </a-button>
        </a-space>
      </template>
      
      <!-- æ“ä½œåˆ— -->
      <template #action_default="{ row }">
        <a-space>
          <a-button type="link" size="small" @click="handleEdit(row)">
            ç¼–è¾‘
          </a-button>
          <a-popconfirm title="ç¡®è®¤åˆ é™¤ï¼Ÿ" @confirm="handleDelete(row.id)">
            <a-button type="link" danger size="small">åˆ é™¤</a-button>
          </a-popconfirm>
        </a-space>
      </template>
    </Grid>
    
    <!-- è¡¨å•å¼¹çª— -->
    <LogisticsServiceFormModal 
      v-if="showModal"
      :visible="showModal"
      :shipment-id="shipmentId"
      :service-id="editingId"
      @close="handleModalClose"
    />
  </div>
</template>
```

**è°ƒæ•´æ–‡ä»¶**ï¼ˆ`FinanceTab.vue`ï¼‰ï¼š
```vue
<script setup lang="ts">
/**
 * å‘è´§å•è¯¦æƒ… - è´¢åŠ¡Tab
 * ä»ç‰©æµæœåŠ¡æ˜ç»†æ±‡æ€»è´¹ç”¨ï¼Œä¸å†ç›´æ¥ä½¿ç”¨shipmentè¡¨çš„å†—ä½™å­—æ®µ
 */
import { onMounted, ref, computed } from 'vue';
import { Alert, Card, Statistic } from 'ant-design-vue';
import { getShipmentLogisticsServices } from '#/api/logistics/shipment-logistics-service';

const props = defineProps<{
  shipmentId: number;
}>();

const logisticsServices = ref<any[]>([]);

async function loadServices() {
  logisticsServices.value = await getShipmentLogisticsServices(props.shipmentId);
}

// è®¡ç®—ç‰©æµæ€»è´¹ç”¨
const totalLogisticsCost = computed(() => {
  return logisticsServices.value.reduce((sum, item) => {
    return sum + (item.actual_amount || item.estimated_amount || 0);
  }, 0);
});

onMounted(() => {
  loadServices();
});

// å®šä¹‰è¡¨æ ¼åˆ—
const columns = [
  { title: 'ID', dataIndex: 'id', key: 'id', width: 60 },
  { title: 'ç‰©æµæœåŠ¡å•†', dataIndex: 'logistics_provider_name', key: 'provider', minWidth: 150 },
  { title: 'æœåŠ¡ç±»å‹', dataIndex: 'service_type', key: 'type', width: 120 },
  { title: 'é¢„ä¼°è´¹ç”¨', dataIndex: 'estimated_amount', key: 'estimated', width: 110 },
  { title: 'å®é™…è´¹ç”¨', dataIndex: 'actual_amount', key: 'actual', width: 110 },
];
</script>

<template>
  <div>
    <Alert type="info" show-icon class="mb-4">
      <template #message>
        <span class="font-semibold">å…³äºç‰©æµæˆæœ¬</span>
      </template>
      <template #description>
        <p class="text-sm">
          ç‰©æµæˆæœ¬ä»"ç‰©æµæœåŠ¡"Tabä¸­çš„æ˜ç»†æ±‡æ€»è®¡ç®—,æ”¯æŒå¤šä¸ªç‰©æµæœåŠ¡å•†çš„è´¹ç”¨åˆ†é¡¹ç®¡ç†ã€‚
        </p>
      </template>
    </Alert>
    
    <!-- ç‰©æµæˆæœ¬æ±‡æ€» -->
    <Card title="ç‰©æµæˆæœ¬æ±‡æ€»" class="mb-4">
      <Statistic
        title="ç‰©æµæ€»æˆæœ¬"
        :value="totalLogisticsCost"
        :precision="2"
        prefix="Â¥"
        :value-style="{ color: '#cf1322', fontSize: '24px' }"
      />
    </Card>
    
    <!-- ç‰©æµæœåŠ¡æ˜ç»† -->
    <Card title="ç‰©æµæœåŠ¡æ˜ç»†">
      <a-table 
        :columns="columns" 
        :data-source="logisticsServices"
        :pagination="false"
        size="small"
      />
    </Card>
  </div>
</template>
```

---

### 4.8 å‰ç«¯ - è¯¦æƒ…é¡µTabé›†æˆ

#### ğŸ“‚ `frontend/apps/web-antd/src/views/logistics/shipment/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `detail.vue` | ğŸ”§ è°ƒæ•´ | å¢åŠ ç‰©æµæœåŠ¡Tab |

**è°ƒæ•´å†…å®¹**ï¼š
```vue
<script setup lang="ts">
// å¯¼å…¥æ–°ç»„ä»¶
import LogisticsServicesPanel from './components/LogisticsServicesPanel.vue';

// ... ç°æœ‰ä»£ç  ...
</script>

<template>
  <div>
    <!-- ... ç°æœ‰ä»£ç  ... -->
    
    <Tabs v-model:activeKey="activeTab">
      <TabPane key="overview" tab="æ¦‚è§ˆ">
        <OverviewTab :shipment="shipment" />
      </TabPane>
      <TabPane key="goods" tab="å•†å“æ˜ç»†">
        <GoodsTab :shipment="shipment" />
      </TabPane>
      
      <!-- æ–°å¢ï¼šç‰©æµæœåŠ¡Tab -->
      <TabPane key="logistics-services" tab="ç‰©æµæœåŠ¡">
        <LogisticsServicesPanel :shipment-id="shipmentId" />
      </TabPane>
      
      <TabPane key="purchase" tab="é‡‡è´­æ˜ç»†">
        <PurchaseTab :shipment-id="shipmentId" />
      </TabPane>
      <TabPane key="logistics" tab="ç‰©æµä¿¡æ¯">
        <LogisticsTab :shipment="shipment" />
      </TabPane>
      <TabPane key="finance" tab="è´¢åŠ¡ä¿¡æ¯">
        <FinanceTab :shipment-id="shipmentId" />
      </TabPane>
      <TabPane key="documents" tab="å‡­è¯ç®¡ç†">
        <DocumentsTab :shipment-id="shipmentId" />
      </TabPane>
      <TabPane key="history" tab="æ“ä½œå†å²">
        <HistoryTab :shipment-id="shipmentId" />
      </TabPane>
    </Tabs>
  </div>
</template>
```

---

## äº”ã€é˜¶æ®µ3ï¼šå‡­è¯ç®¡ç†ä¸­å¿ƒï¼ˆ3-4å¤©ï¼‰

### 5.1 åç«¯ - Servicesæ‰©å±•

#### ğŸ“‚ `backend/app/services/document/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `document_service.py` | ğŸ”§ å®Œå–„ | å®ç°å®Œæ•´çš„ä¸Šä¼ /æŸ¥è¯¢/å½’æ¡£é€»è¾‘ |
| `archive_service.py` | ğŸ†• æ–°å»º | è‡ªåŠ¨å½’æ¡£æœåŠ¡ |

**å®Œå–„å†…å®¹**ï¼ˆ`document_service.py`ï¼‰ï¼š
```python
"""
å‡­è¯ç®¡ç†æœåŠ¡å±‚
å¤„ç†å‡­è¯ä¸Šä¼ ã€æŸ¥è¯¢ã€å®¡æ ¸ã€å½’æ¡£ç­‰ä¸šåŠ¡é€»è¾‘
"""
from typing import List, Optional
from datetime import datetime
import os
from app.models.document.document_center import DocumentCenter, BusinessType
from app.extensions import db
from app.errors import BusinessError

class DocumentService:
    """å‡­è¯ç®¡ç†ä¸šåŠ¡é€»è¾‘ç±»"""
    
    @staticmethod
    def upload_document(business_type: str, business_id: int, file, metadata: dict, uploaded_by: int):
        """
        ä¸Šä¼ å‡­è¯
        
        Args:
            business_type: ä¸šåŠ¡ç±»å‹(logistics/purchase/customs/payment)
            business_id: ä¸šåŠ¡å•æ®ID
            file: æ–‡ä»¶å¯¹è±¡
            metadata: å…ƒæ•°æ®(document_type, document_categoryç­‰)
            uploaded_by: ä¸Šä¼ äººID
        """
        # éªŒè¯æ–‡ä»¶
        if not file:
            raise BusinessError('æ–‡ä»¶ä¸èƒ½ä¸ºç©º', code=400)
        
        # ç”Ÿæˆæ–‡ä»¶è·¯å¾„ï¼ˆå®é™…é¡¹ç›®ä¸­åº”ä¿å­˜åˆ°OSS/NASï¼‰
        file_name = file.filename
        file_path = f"uploads/{business_type}/{business_id}/{file_name}"
        
        # ä¿å­˜æ–‡ä»¶ï¼ˆç¤ºä¾‹ï¼‰
        # file.save(file_path)
        
        # åˆ›å»ºå‡­è¯è®°å½•
        document = DocumentCenter(
            business_type=business_type,
            business_id=business_id,
            document_type=metadata.get('document_type'),
            document_category=metadata.get('document_category'),
            file_name=file_name,
            file_path=file_path,
            file_size=len(file.read()),
            file_type=os.path.splitext(file_name)[1],
            uploaded_by_id=uploaded_by,
            uploaded_at=datetime.now()
        )
        
        db.session.add(document)
        db.session.commit()
        return document
    
    @staticmethod
    def get_documents_by_business(business_type: str, business_id: int) -> List[DocumentCenter]:
        """æŒ‰ä¸šåŠ¡å•æ®æŸ¥è¯¢å‡­è¯"""
        return DocumentCenter.query.filter_by(
            business_type=business_type,
            business_id=business_id
        ).all()
    
    @staticmethod
    def get_documents_by_shipment(shipment_id: int) -> List[DocumentCenter]:
        """è·å–å‘è´§å•çš„æ‰€æœ‰å‡­è¯"""
        return DocumentService.get_documents_by_business('logistics', shipment_id)
    
    @staticmethod
    def approve_document(document_id: int, approved_by: int, notes: Optional[str] = None):
        """å®¡æ ¸å‡­è¯"""
        document = DocumentCenter.query.get(document_id)
        if not document:
            raise BusinessError('å‡­è¯ä¸å­˜åœ¨', code=404)
        
        document.audit_status = 'approved'
        document.audited_by_id = approved_by
        document.audited_at = datetime.now()
        document.audit_notes = notes
        
        db.session.commit()
        return document
    
    # ... å…¶ä»–æ–¹æ³•
```

**æ–°å»ºå†…å®¹**ï¼ˆ`archive_service.py`ï¼‰ï¼š
```python
"""
è‡ªåŠ¨å½’æ¡£æœåŠ¡
å½“æŠ¥å…³å•å®¡æ ¸é€šè¿‡åï¼Œè‡ªåŠ¨æ‰“åŒ…æ‰€æœ‰ç›¸å…³å‡­è¯è¿›è¡Œå½’æ¡£
"""
from typing import List
from datetime import datetime
import os
import zipfile
from app.models.document.document_center import DocumentCenter
from app.models.customs.declaration import CustomsDeclaration
from app.extensions import db
from app.errors import BusinessError

class ArchiveService:
    """å½’æ¡£æœåŠ¡ç±»"""
    
    @staticmethod
    def archive_by_customs_declaration(declaration_id: int) -> str:
        """
        æŒ‰æŠ¥å…³å•å½’æ¡£
        
        Returns:
            å½’æ¡£æ–‡ä»¶è·¯å¾„
        """
        from app.services.document.document_service import DocumentService
        
        declaration = CustomsDeclaration.query.get(declaration_id)
        if not declaration:
            raise BusinessError('æŠ¥å…³å•ä¸å­˜åœ¨', code=404)
        
        # æ”¶é›†æ‰€æœ‰ç›¸å…³å‡­è¯
        documents = []
        
        # 1. æŠ¥å…³å•å‡­è¯
        customs_docs = DocumentService.get_documents_by_business('customs', declaration_id)
        documents.extend(customs_docs)
        
        # 2. å‘è´§å•å‡­è¯
        if declaration.shipment_id:
            shipment_docs = DocumentService.get_documents_by_business('logistics', declaration.shipment_id)
            documents.extend(shipment_docs)
        
        # 3. æ‰“åŒ…æˆZIP
        archive_path = f"archives/customs_{declaration.declaration_no}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.zip"
        
        with zipfile.ZipFile(archive_path, 'w') as zipf:
            for doc in documents:
                zipf.write(doc.file_path, arcname=doc.file_name)
        
        # 4. æ›´æ–°å½’æ¡£çŠ¶æ€
        for doc in documents:
            doc.archived = True
            doc.archive_path = archive_path
            doc.archived_at = datetime.now()
        
        db.session.commit()
        
        return archive_path
    
    @staticmethod
    def archive_by_shipment(shipment_id: int) -> str:
        """æŒ‰å‘è´§å•å½’æ¡£"""
        # ç±»ä¼¼é€»è¾‘
        pass
    
    @staticmethod
    def archive_by_supplier(supplier_id: int, start_date, end_date) -> str:
        """æŒ‰ä¾›åº”å•†å½’æ¡£"""
        # ç±»ä¼¼é€»è¾‘
        pass
    
    @staticmethod
    def archive_by_month(year: int, month: int) -> str:
        """æŒ‰æœˆåº¦å½’æ¡£"""
        # ç±»ä¼¼é€»è¾‘
        pass
```

---

### 5.2 åç«¯ - API Routesæ‰©å±•

#### ğŸ“‚ `backend/app/api/document/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `document_routes.py` | ğŸ”§ å®Œå–„ | å®ç°å®Œæ•´çš„APIæ¥å£ |

**å®Œå–„å†…å®¹**ï¼š
```python
"""å‡­è¯ç®¡ç†APIè·¯ç”±"""
from apiflask import APIBlueprint, FileSchema
from apiflask.views import MethodView
from flask import request
from flask_jwt_extended import get_jwt_identity
from app.security import auth
from app.services.document.document_service import DocumentService
from app.services.document.archive_service import ArchiveService

document_bp = APIBlueprint('documents', __name__, url_prefix='/documents', tag='å‡­è¯ç®¡ç†')

class DocumentUploadAPI(MethodView):
    """å‡­è¯ä¸Šä¼ API"""
    decorators = [document_bp.auth_required(auth)]
    
    @document_bp.doc(summary='ä¸Šä¼ å‡­è¯')
    @document_bp.input(FileSchema, location='files', arg_name='files')
    def post(self):
        """ä¸Šä¼ å‡­è¯"""
        user_id = get_jwt_identity()
        
        # è·å–å‚æ•°
        business_type = request.form.get('business_type')
        business_id = request.form.get('business_id')
        document_type = request.form.get('document_type')
        document_category = request.form.get('document_category')
        
        # è·å–æ–‡ä»¶
        file = request.files.get('file')
        
        # ä¸Šä¼ 
        document = DocumentService.upload_document(
            business_type=business_type,
            business_id=business_id,
            file=file,
            metadata={
                'document_type': document_type,
                'document_category': document_category
            },
            uploaded_by=user_id
        )
        
        return {'data': document}

class DocumentListAPI(MethodView):
    """å‡­è¯åˆ—è¡¨API"""
    decorators = [document_bp.auth_required(auth)]
    
    @document_bp.doc(summary='æŸ¥è¯¢å‡­è¯åˆ—è¡¨')
    def get(self):
        """æŸ¥è¯¢å‡­è¯"""
        business_type = request.args.get('business_type')
        business_id = request.args.get('business_id')
        
        if business_type and business_id:
            documents = DocumentService.get_documents_by_business(business_type, int(business_id))
        else:
            # æŸ¥è¯¢æ‰€æœ‰
            documents = DocumentCenter.query.all()
        
        return {'data': documents}

class ArchiveAPI(MethodView):
    """å½’æ¡£API"""
    decorators = [document_bp.auth_required(auth)]
    
    @document_bp.doc(summary='æŒ‰æŠ¥å…³å•å½’æ¡£')
    def post(self):
        """è§¦å‘å½’æ¡£"""
        archive_type = request.json.get('archive_type')  # shipment/customs/supplier/month
        archive_id = request.json.get('archive_id')
        
        if archive_type == 'customs':
            archive_path = ArchiveService.archive_by_customs_declaration(archive_id)
        elif archive_type == 'shipment':
            archive_path = ArchiveService.archive_by_shipment(archive_id)
        # ... å…¶ä»–ç±»å‹
        
        return {'data': {'archive_path': archive_path}}

# æ³¨å†Œè·¯ç”±
document_bp.add_url_rule('/upload', view_func=DocumentUploadAPI.as_view('upload'))
document_bp.add_url_rule('', view_func=DocumentListAPI.as_view('list'))
document_bp.add_url_rule('/archive', view_func=ArchiveAPI.as_view('archive'))
```

---

### 5.3 å‰ç«¯ - é€šç”¨ç»„ä»¶å¼€å‘

#### ğŸ“‚ `frontend/apps/web-antd/src/components/document/`ï¼ˆæ–°å»ºç›®å½•ï¼‰

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `DocumentUploader.vue` | ğŸ†• æ–°å»º | å‡­è¯ä¸Šä¼ ç»„ä»¶ï¼ˆæ”¯æŒæ‹–æ‹½ã€å¤šæ–‡ä»¶ï¼‰ |
| `DocumentList.vue` | ğŸ†• æ–°å»º | å‡­è¯åˆ—è¡¨å±•ç¤ºç»„ä»¶ |
| `DocumentPreview.vue` | ğŸ†• æ–°å»º | å‡­è¯é¢„è§ˆç»„ä»¶ï¼ˆPDF/å›¾ç‰‡/Excelï¼‰ |

**æ–°å»ºå†…å®¹**ï¼ˆ`DocumentUploader.vue`ï¼‰ï¼š
```vue
<script setup lang="ts">
/**
 * é€šç”¨å‡­è¯ä¸Šä¼ ç»„ä»¶
 * æ”¯æŒæ‹–æ‹½ã€å¤šæ–‡ä»¶ã€é¢„è§ˆã€åˆ é™¤
 */
import { Upload, message } from 'ant-design-vue';
import { InboxOutlined } from '@ant-design/icons-vue';
import { ref } from 'vue';
import { uploadDocument } from '#/api/document/document';

const props = defineProps<{
  businessType: string;  // logistics/purchase/customs/payment
  businessId: number;
  documentType: string;
  documentCategory: string;
}>();

const emit = defineEmits<{
  (e: 'success'): void;
}>();

const fileList = ref<any[]>([]);
const uploading = ref(false);

const uploadProps = {
  name: 'file',
  multiple: true,
  accept: '.pdf,.jpg,.jpeg,.png,.xlsx,.xls',
  customRequest: async (options: any) => {
    try {
      uploading.value = true;
      
      const formData = new FormData();
      formData.append('file', options.file);
      formData.append('business_type', props.businessType);
      formData.append('business_id', String(props.businessId));
      formData.append('document_type', props.documentType);
      formData.append('document_category', props.documentCategory);
      
      await uploadDocument(formData);
      
      message.success(`${options.file.name} ä¸Šä¼ æˆåŠŸ`);
      options.onSuccess();
      emit('success');
    } catch (error: any) {
      message.error(`${options.file.name} ä¸Šä¼ å¤±è´¥: ${error.message}`);
      options.onError(error);
    } finally {
      uploading.value = false;
    }
  },
  onChange(info: any) {
    fileList.value = info.fileList;
  },
};
</script>

<template>
  <div>
    <Upload.Dragger v-bind="uploadProps" :file-list="fileList">
      <p class="ant-upload-drag-icon">
        <InboxOutlined />
      </p>
      <p class="ant-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸä¸Šä¼ </p>
      <p class="ant-upload-hint">
        æ”¯æŒ PDFã€å›¾ç‰‡ã€Excel æ ¼å¼ï¼Œå¯ä¸€æ¬¡ä¸Šä¼ å¤šä¸ªæ–‡ä»¶
      </p>
    </Upload.Dragger>
  </div>
</template>
```

---

### 5.4 å‰ç«¯ - é›†æˆåˆ°ä¸šåŠ¡é¡µé¢

#### ğŸ“‚ `frontend/apps/web-antd/src/views/logistics/shipment/components/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `DocumentsTab.vue` | ğŸ”§ è°ƒæ•´ | ä½¿ç”¨é€šç”¨å‡­è¯ç»„ä»¶ |
| `LogisticsServiceFormModal.vue` | ğŸ”§ è°ƒæ•´ | é›†æˆå‡­è¯ä¸Šä¼  |

**è°ƒæ•´å†…å®¹**ï¼ˆ`DocumentsTab.vue`ï¼‰ï¼š
```vue
<script setup lang="ts">
/**
 * å‘è´§å•è¯¦æƒ… - å‡­è¯ç®¡ç†Tab
 * ä½¿ç”¨é€šç”¨å‡­è¯ç»„ä»¶
 */
import { ref, onMounted } from 'vue';
import { Card } from 'ant-design-vue';
import DocumentUploader from '#/components/document/DocumentUploader.vue';
import DocumentList from '#/components/document/DocumentList.vue';
import { getDocumentsByBusiness } from '#/api/document/document';

const props = defineProps<{
  shipmentId: number;
}>();

const documents = ref<any[]>([]);

async function loadDocuments() {
  documents.value = await getDocumentsByBusiness('logistics', props.shipmentId);
}

onMounted(() => {
  loadDocuments();
});

function handleUploadSuccess() {
  loadDocuments();
}
</script>

<template>
  <div>
    <!-- ä¸Šä¼ åŒº -->
    <Card title="ä¸Šä¼ å‡­è¯" class="mb-4">
      <DocumentUploader 
        business-type="logistics"
        :business-id="shipmentId"
        document-type="logistics_voucher"
        document-category="service_voucher"
        @success="handleUploadSuccess"
      />
    </Card>
    
    <!-- å‡­è¯åˆ—è¡¨ -->
    <Card title="å·²ä¸Šä¼ å‡­è¯">
      <DocumentList :documents="documents" @refresh="loadDocuments" />
    </Card>
  </div>
</template>
```

---

## å…­ã€é˜¶æ®µ4ï¼šç‰©æµå¯¹è´¦ä¸ä»˜æ¬¾ï¼ˆ3-4å¤©ï¼‰

### 6.1 åç«¯ - æ•°æ®åº“è¿ç§»

#### ğŸ“‚ `backend/migrations/versions/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `[timestamp]_add_logistics_statement_and_payment.py` | ğŸ†• æ–°å»º | åˆ›å»ºç‰©æµå¯¹è´¦å•å’Œç‰©æµä»˜æ¬¾å•è¡¨ |

**è¿ç§»å†…å®¹**ï¼š
```python
"""åˆ›å»ºç‰©æµå¯¹è´¦å•å’Œç‰©æµä»˜æ¬¾å•è¡¨"""
def upgrade():
    # 1. åˆ›å»ºç‰©æµå¯¹è´¦å•è¡¨
    op.create_table(
        'logistics_statements',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('statement_no', sa.String(50), unique=True, nullable=False),
        sa.Column('shipment_id', sa.Integer(), nullable=False),
        sa.Column('logistics_provider_id', sa.Integer(), nullable=False),
        sa.Column('statement_date', sa.Date()),
        sa.Column('total_amount', sa.DECIMAL(18, 2)),
        sa.Column('currency', sa.String(10), default='CNY'),
        sa.Column('payment_method', sa.String(20)),
        sa.Column('status', sa.String(20), default='draft'),  # draft/confirmed/paid
        sa.Column('confirmed_by_id', sa.Integer()),
        sa.Column('confirmed_at', sa.DateTime()),
        sa.Column('notes', sa.Text()),
        sa.Column('created_at', sa.DateTime(), server_default=sa.func.now()),
        sa.Column('updated_at', sa.DateTime(), onupdate=sa.func.now()),
        sa.PrimaryKeyConstraint('id'),
        sa.ForeignKeyConstraint(['shipment_id'], ['shipment_orders.id']),
        sa.ForeignKeyConstraint(['logistics_provider_id'], ['logistics_providers.id']),
        sa.ForeignKeyConstraint(['confirmed_by_id'], ['users.id']),
    )
    
    # 2. åˆ›å»ºç‰©æµä»˜æ¬¾å•è¡¨
    op.create_table(
        'logistics_payments',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('payment_no', sa.String(50), unique=True),
        sa.Column('statement_id', sa.Integer(), nullable=False),
        sa.Column('payment_date', sa.Date()),
        sa.Column('payment_amount', sa.DECIMAL(18, 2)),
        sa.Column('currency', sa.String(10)),
        sa.Column('payment_pool_id', sa.Integer()),  # å¤–é”® â†’ fin_payment_pool
        sa.Column('status', sa.String(20), default='pending'),  # pending/approved/paid
        sa.Column('approved_by_id', sa.Integer()),
        sa.Column('approved_at', sa.DateTime()),
        sa.Column('paid_at', sa.DateTime()),
        sa.Column('notes', sa.Text()),
        sa.Column('created_at', sa.DateTime(), server_default=sa.func.now()),
        sa.PrimaryKeyConstraint('id'),
        sa.ForeignKeyConstraint(['statement_id'], ['logistics_statements.id']),
        sa.ForeignKeyConstraint(['payment_pool_id'], ['fin_payment_pool.id']),
        sa.ForeignKeyConstraint(['approved_by_id'], ['users.id']),
    )
    
    # ç´¢å¼•
    op.create_index('idx_ls_shipment_id', 'logistics_statements', ['shipment_id'])
    op.create_index('idx_ls_provider_id', 'logistics_statements', ['logistics_provider_id'])
    op.create_index('idx_lp_statement_id', 'logistics_payments', ['statement_id'])
```

---

### 6.2 åç«¯ - Models

#### ğŸ“‚ `backend/app/models/logistics/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `logistics_statement.py` | ğŸ†• æ–°å»º | ç‰©æµå¯¹è´¦å•æ¨¡å‹ |
| `logistics_payment.py` | ğŸ†• æ–°å»º | ç‰©æµä»˜æ¬¾å•æ¨¡å‹ |

---

### 6.3 åç«¯ - Services

#### ğŸ“‚ `backend/app/services/logistics/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `logistics_statement_service.py` | ğŸ†• æ–°å»º | ç‰©æµå¯¹è´¦å•ä¸šåŠ¡é€»è¾‘ |
| `logistics_payment_service.py` | ğŸ†• æ–°å»º | ç‰©æµä»˜æ¬¾å•ä¸šåŠ¡é€»è¾‘ |

**æ–°å»ºå†…å®¹**ï¼ˆ`logistics_statement_service.py`ï¼‰ï¼š
```python
"""
ç‰©æµå¯¹è´¦å•æœåŠ¡å±‚
å¤„ç†ç‰©æµå¯¹è´¦å•çš„åˆ›å»ºã€ç¡®è®¤ã€ç”Ÿæˆä»˜æ¬¾å•ç­‰ä¸šåŠ¡é€»è¾‘

ã€é‡è¦è¯´æ˜ã€‘ï¼š
- ç‰©æµæœåŠ¡å•†æ— APIæ¥å£ï¼Œæ— æ³•è‡ªåŠ¨å¯¹è´¦
- å¯¹è´¦å•ç”±è´¢åŠ¡äººå‘˜æ ¹æ®æœåŠ¡å•†æä¾›çš„çº¸è´¨/ç”µå­è´¦å•æ‰‹å·¥æ ¸å¯¹ååˆ›å»º
- ç³»ç»Ÿæä¾›ä»ç‰©æµæœåŠ¡æ˜ç»†ç”Ÿæˆå¯¹è´¦å•è‰ç¨¿çš„åŠŸèƒ½ï¼Œä½†é‡‘é¢éœ€äººå·¥ç¡®è®¤
"""
from datetime import datetime
from app.models.logistics.logistics_statement import LogisticsStatement
from app.models.logistics.shipment_logistics_service import ShipmentLogisticsService
from app.extensions import db
from app.errors import BusinessError

class LogisticsStatementService:
    """ç‰©æµå¯¹è´¦å•ä¸šåŠ¡é€»è¾‘ç±»"""
    
    @staticmethod
    def generate_statement_from_services(shipment_id: int, provider_id: int, data: dict):
        """
        ä»ç‰©æµæœåŠ¡æ˜ç»†ç”Ÿæˆå¯¹è´¦å•è‰ç¨¿ï¼ˆéœ€äººå·¥ç¡®è®¤é‡‘é¢ï¼‰
        
        Args:
            shipment_id: å‘è´§å•ID
            provider_id: ç‰©æµæœåŠ¡å•†ID
            data: å¯¹è´¦å•æ•°æ®
        
        æ³¨æ„ï¼š
        - ç”Ÿæˆçš„å¯¹è´¦å•ä¸ºè‰ç¨¿çŠ¶æ€ï¼Œé‡‘é¢ä»actual_amountå–å€¼
        - è´¢åŠ¡äººå‘˜éœ€æ ¸å¯¹æœåŠ¡å•†è´¦å•åï¼Œæ‰‹å·¥ç¡®è®¤æˆ–è°ƒæ•´é‡‘é¢
        """
        # è·å–è¯¥æœåŠ¡å•†çš„æ‰€æœ‰ç‰©æµæœåŠ¡
        services = ShipmentLogisticsService.query.filter_by(
            shipment_id=shipment_id,
            logistics_provider_id=provider_id,
            status='confirmed'  # åªå¯¹è´¦å·²ç¡®è®¤çš„æœåŠ¡
        ).all()
        
        if not services:
            raise BusinessError('æ²¡æœ‰å¯å¯¹è´¦çš„ç‰©æµæœåŠ¡', code=400)
        
        # è®¡ç®—æ€»é‡‘é¢
        total_amount = sum(s.actual_amount or s.estimated_amount or 0 for s in services)
        
        # ç”Ÿæˆå¯¹è´¦å•å·
        statement_no = f"LS{datetime.now().strftime('%Y%m%d%H%M%S')}"
        
        # åˆ›å»ºå¯¹è´¦å•
        statement = LogisticsStatement(
            statement_no=statement_no,
            shipment_id=shipment_id,
            logistics_provider_id=provider_id,
            statement_date=datetime.now().date(),
            total_amount=total_amount,
            currency=data.get('currency', 'CNY'),
            payment_method=data.get('payment_method'),
            status='draft'
        )
        
        db.session.add(statement)
        db.session.commit()
        
        # æ›´æ–°ç‰©æµæœåŠ¡çŠ¶æ€
        for service in services:
            service.status = 'reconciled'
            service.reconciled_at = datetime.now()
        
        db.session.commit()
        
        return statement
    
    @staticmethod
    def confirm_statement(statement_id: int, confirmed_by: int):
        """ç¡®è®¤å¯¹è´¦å•ï¼Œè‡ªåŠ¨ç”Ÿæˆä»˜æ¬¾å•"""
        statement = LogisticsStatement.query.get(statement_id)
        if not statement:
            raise BusinessError('å¯¹è´¦å•ä¸å­˜åœ¨', code=404)
        
        if statement.status != 'draft':
            raise BusinessError('åªèƒ½ç¡®è®¤è‰ç¨¿çŠ¶æ€çš„å¯¹è´¦å•', code=400)
        
        # ç¡®è®¤å¯¹è´¦å•
        statement.status = 'confirmed'
        statement.confirmed_by_id = confirmed_by
        statement.confirmed_at = datetime.now()
        
        db.session.commit()
        
        # è‡ªåŠ¨ç”Ÿæˆä»˜æ¬¾å•
        from app.services.logistics.logistics_payment_service import LogisticsPaymentService
        payment = LogisticsPaymentService.create_payment_from_statement(statement_id)
        
        return statement, payment
```

---

## ä¸ƒã€é˜¶æ®µ5ï¼šä»˜æ¬¾æ± æ‰©å±•ï¼ˆ2å¤©ï¼‰

### 7.1 åç«¯ - æ•°æ®åº“è¿ç§»

#### ğŸ“‚ `backend/migrations/versions/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `[timestamp]_extend_payment_pool_for_logistics.py` | ğŸ†• æ–°å»º | æ‰©å±•ä»˜æ¬¾æ± æ”¯æŒç‰©æµè´¹ç”¨ |

**è¿ç§»å†…å®¹**ï¼š
```python
"""æ‰©å±•ä»˜æ¬¾æ± æ”¯æŒç‰©æµè´¹ç”¨"""
def upgrade():
    # 1. å¢åŠ å­—æ®µ
    op.add_column('fin_payment_pool', 
        sa.Column('payment_type', sa.String(20), default='purchase', comment='ä»˜æ¬¾ç±»å‹: purchase/logistics/other')
    )
    op.add_column('fin_payment_pool',
        sa.Column('related_statement_type', sa.String(30), comment='å…³è”å¯¹è´¦å•ç±»å‹: purchase_soa/logistics_statement')
    )
    op.add_column('fin_payment_pool',
        sa.Column('related_statement_id', sa.Integer(), comment='å…³è”å¯¹è´¦å•ID')
    )
    
    # 2. æ›´æ–°ç°æœ‰æ•°æ®ï¼ˆå°†ç°æœ‰è®°å½•æ ‡è®°ä¸ºpurchaseç±»å‹ï¼‰
    op.execute("UPDATE fin_payment_pool SET payment_type = 'purchase' WHERE payment_type IS NULL")
    
    # 3. åˆ›å»ºç´¢å¼•
    op.create_index('idx_fp_payment_type', 'fin_payment_pool', ['payment_type'])
```

---

### 7.2 åç«¯ - Modelsæ‰©å±•

#### ğŸ“‚ `backend/app/models/serc/finance.py`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `finance.py` | ğŸ”§ è°ƒæ•´ | æ‰©å±•FinPaymentPoolæ¨¡å‹ |

**è°ƒæ•´å†…å®¹**ï¼š
```python
class FinPaymentPool(db.Model):
    """L3: èµ„é‡‘æ± /ä»˜æ¬¾è®¡åˆ’ (Payment Schedule)"""
    __tablename__ = "fin_payment_pool"
    
    # ... ç°æœ‰å­—æ®µ ...
    
    # æ–°å¢å­—æ®µ
    payment_type: Mapped[str] = mapped_column(
        String(20), 
        default='purchase', 
        comment='ä»˜æ¬¾ç±»å‹: purchase/logistics/other'
    )
    related_statement_type: Mapped[Optional[str]] = mapped_column(
        String(30), 
        comment='å…³è”å¯¹è´¦å•ç±»å‹: purchase_soa/logistics_statement'
    )
    related_statement_id: Mapped[Optional[int]] = mapped_column(
        Integer, 
        comment='å…³è”å¯¹è´¦å•ID'
    )
    
    # ... å…¶ä½™ä»£ç  ...
```

---

### 7.3 åç«¯ - Servicesæ‰©å±•

#### ğŸ“‚ `backend/app/services/serc/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `payment_pool_service.py` | ğŸ”§ è°ƒæ•´ | æ‰©å±•æ”¯æŒç‰©æµè´¹ç”¨ |

**è°ƒæ•´å†…å®¹**ï¼š
```python
class PaymentPoolService:
    """ä»˜æ¬¾æ± ä¸šåŠ¡é€»è¾‘ç±»"""
    
    @staticmethod
    def add_to_pool(payment_type: str, statement_id: int, amount: Decimal, **kwargs):
        """
        åŠ å…¥ä»˜æ¬¾æ± ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
        
        Args:
            payment_type: 'purchase' | 'logistics' | 'other'
            statement_id: å¯¹è´¦å•ID
            amount: ä»˜æ¬¾é‡‘é¢
        """
        # ç¡®å®šå…³è”å¯¹è´¦å•ç±»å‹
        if payment_type == 'purchase':
            related_type = 'purchase_soa'
        elif payment_type == 'logistics':
            related_type = 'logistics_statement'
        else:
            related_type = 'other'
        
        # åˆ›å»ºä»˜æ¬¾æ± è®°å½•
        pool_item = FinPaymentPool(
            payment_type=payment_type,
            related_statement_type=related_type,
            related_statement_id=statement_id,
            amount=amount,
            currency=kwargs.get('currency', 'CNY'),
            due_date=kwargs.get('due_date'),
            priority=kwargs.get('priority', 0),
            status='pending_approval'
        )
        
        db.session.add(pool_item)
        db.session.commit()
        return pool_item
    
    @staticmethod
    def get_pool_items(payment_type: Optional[str] = None):
        """è·å–ä»˜æ¬¾æ± åˆ—è¡¨ï¼ˆæ”¯æŒæŒ‰ç±»å‹ç­›é€‰ï¼‰"""
        query = FinPaymentPool.query
        
        if payment_type:
            query = query.filter_by(payment_type=payment_type)
        
        return query.order_by(FinPaymentPool.priority.desc(), FinPaymentPool.due_date).all()
```

---

### 7.4 å‰ç«¯ - é¡µé¢è°ƒæ•´

#### ğŸ“‚ `frontend/apps/web-antd/src/views/serc/finance/`

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `pool.vue` | ğŸ”§ è°ƒæ•´ | å¢åŠ ä»˜æ¬¾ç±»å‹ç­›é€‰ |

**è°ƒæ•´å†…å®¹**ï¼š
```vue
<script setup lang="ts">
/**
 * æ³¨æ„ï¼šä»¥ä¸‹æ˜¯åœ¨ç°æœ‰ pool.vue ä»£ç åŸºç¡€ä¸Šçš„å¢é‡è°ƒæ•´
 * ç°æœ‰ä»£ç åŒ…å«ï¼š
 * - import { ref } from 'vue';
 * - import { useVbenVxeGrid, type VxeGridProps } from '#/adapter/vxe-table';
 * - import { getPaymentPoolItems } from '#/api/serc/finance';
 * - ç°æœ‰çš„ Grid å’Œ gridApi åˆå§‹åŒ–
 */

// å¢åŠ ä»˜æ¬¾ç±»å‹ç­›é€‰
const paymentType = ref<string>('all');  // all/purchase/logistics

const gridOptions: VxeGridProps = {
  columns: [
    // ... ç°æœ‰åˆ— ...
    { 
      field: 'payment_type', 
      title: 'ä»˜æ¬¾ç±»å‹', 
      width: 100,
      slots: { default: 'payment_type_default' }
    },
    // ...
  ],
  // ...
};

// åŠ è½½æ•°æ®æ—¶ä¼ å…¥ç­›é€‰å‚æ•°
async function loadData() {
  const params: any = {};
  if (paymentType.value !== 'all') {
    params.payment_type = paymentType.value;
  }
  
  const res = await getPaymentPoolItems(params);
  gridApi.setGridOptions({ data: res });
}

// è¾…åŠ©å‡½æ•°ï¼šä»˜æ¬¾ç±»å‹é¢œè‰²æ˜ å°„
function getPaymentTypeColor(type: string): string {
  const colorMap: Record<string, string> = {
    purchase: 'blue',
    logistics: 'green',
    other: 'default',
  };
  return colorMap[type] || 'default';
}

// è¾…åŠ©å‡½æ•°ï¼šä»˜æ¬¾ç±»å‹æ–‡æœ¬æ˜ å°„
function getPaymentTypeText(type: string): string {
  const textMap: Record<string, string> = {
    purchase: 'å•†å“é‡‡è´­',
    logistics: 'ç‰©æµè´¹ç”¨',
    other: 'å…¶ä»–',
  };
  return textMap[type] || type;
}
</script>

<template>
  <div class="p-4">
    <!-- ç­›é€‰å™¨ -->
    <div class="mb-4">
      <a-radio-group v-model:value="paymentType" @change="loadData">
        <a-radio-button value="all">å…¨éƒ¨</a-radio-button>
        <a-radio-button value="purchase">å•†å“é‡‡è´­</a-radio-button>
        <a-radio-button value="logistics">ç‰©æµè´¹ç”¨</a-radio-button>
      </a-radio-group>
    </div>
    
    <Grid>
      <!-- ä»˜æ¬¾ç±»å‹åˆ— -->
      <template #payment_type_default="{ row }">
        <a-tag :color="getPaymentTypeColor(row.payment_type)">
          {{ getPaymentTypeText(row.payment_type) }}
        </a-tag>
      </template>
    </Grid>
  </div>
</template>
```

---

## å…«ã€é˜¶æ®µ6ï¼šé›†æˆæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ2-3å¤©ï¼‰

### 8.1 åç«¯ - å•å…ƒæµ‹è¯•

#### ğŸ“‚ `backend/tests/`

| ç›®å½•/æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|----------|------|------|
| `test_logistics_provider.py` | ğŸ†• æ–°å»º | ç‰©æµæœåŠ¡å•†æµ‹è¯• |
| `test_logistics_statement.py` | ğŸ†• æ–°å»º | ç‰©æµå¯¹è´¦å•æµ‹è¯• |
| `test_document_service.py` | ğŸ†• æ–°å»º | å‡­è¯ç®¡ç†æµ‹è¯• |
| `test_payment_pool_extension.py` | ğŸ†• æ–°å»º | ä»˜æ¬¾æ± æ‰©å±•æµ‹è¯• |
| `integration/test_logistics_flow.py` | ğŸ†• æ–°å»º | ç‰©æµè´¹ç”¨å®Œæ•´æµç¨‹é›†æˆæµ‹è¯• |

**ç¤ºä¾‹**ï¼ˆ`test_logistics_provider.py`ï¼‰ï¼š
```python
"""ç‰©æµæœåŠ¡å•†å•å…ƒæµ‹è¯•"""
import pytest
from app.models.logistics.logistics_provider import LogisticsProvider
from app.services.logistics.logistics_provider_service import LogisticsProviderService

def test_create_logistics_provider(app, db):
    """æµ‹è¯•åˆ›å»ºç‰©æµæœåŠ¡å•†"""
    data = {
        'provider_name': 'é¡ºä¸°é€Ÿè¿',
        'provider_code': 'SF001',
        'service_type': 'domestic_trucking',
        'payment_method': 'postpaid',
        'settlement_cycle': 'monthly'
    }
    
    provider = LogisticsProviderService.create_provider(data, created_by=1)
    
    assert provider.id is not None
    assert provider.provider_name == 'é¡ºä¸°é€Ÿè¿'
    assert provider.provider_code == 'SF001'

def test_create_duplicate_provider_code(app, db):
    """æµ‹è¯•åˆ›å»ºé‡å¤ç¼–ç çš„æœåŠ¡å•†"""
    # ... æµ‹è¯•é€»è¾‘
```

---

### 8.2 æ€§èƒ½ä¼˜åŒ–æ¸…å•

| ä¼˜åŒ–é¡¹ | ä½ç½® | è¯´æ˜ |
|--------|------|------|
| æ•°æ®åº“ç´¢å¼•æ£€æŸ¥ | æ‰€æœ‰æ–°å»ºè¡¨ | ç¡®ä¿å…³é”®å­—æ®µæœ‰ç´¢å¼• |
| N+1æŸ¥è¯¢ä¼˜åŒ– | Serviceså±‚ | ä½¿ç”¨selectinload/joinedload |
| APIå“åº”æ—¶é—´ç›‘æ§ | å…¨å±€ä¸­é—´ä»¶ | è®°å½•æ…¢æ¥å£(>200ms) |
| å‰ç«¯è™šæ‹Ÿæ»šåŠ¨ | å¤§åˆ—è¡¨ç»„ä»¶ | ä½¿ç”¨vxe-tableçš„è™šæ‹Ÿæ»šåŠ¨ |
| å›¾ç‰‡æ‡’åŠ è½½ | å‡­è¯é¢„è§ˆç»„ä»¶ | ä½¿ç”¨IntersectionObserver |

---

## ä¹ã€åºŸå¼ƒä»£ç è¿ç§»è®¡åˆ’

### 9.1 é€æ­¥åºŸå¼ƒçš„æ–‡ä»¶

| æ–‡ä»¶ | åºŸå¼ƒåŸå›  | è¿ç§»æ–¹æ¡ˆ |
|------|---------|----------|
| `backend/app/models/customs/attachment.py` | æ›¿æ¢ä¸ºé€šç”¨å‡­è¯ç®¡ç† | ä¿ç•™å‘åå…¼å®¹ï¼Œæ–°ä¸šåŠ¡ä½¿ç”¨document_center |
| `frontend/apps/web-antd/src/views/customs/declaration/components/DeclarationFilePanel.vue` | æ›¿æ¢ä¸ºé€šç”¨å‡­è¯ç»„ä»¶ | é€æ­¥è¿ç§»åˆ°DocumentUploaderç»„ä»¶ |

---

## åã€æ€»ç»“

### 10.1 ä»£ç è°ƒæ•´ç»Ÿè®¡

| ç±»å‹ | åç«¯æ–‡ä»¶æ•° | å‰ç«¯æ–‡ä»¶æ•° | æ€»è®¡ |
|------|-----------|-----------|------|
| ğŸ†• æ–°å»º | 35+ | 20+ | 55+ |
| ğŸ”§ è°ƒæ•´ | 8+ | 10+ | 18+ |
| ğŸ—‘ï¸ åºŸå¼ƒ | 2 | 2 | 4 |
| **æ€»è®¡** | **45+** | **32+** | **77+** |

### 10.2 å…³é”®è°ƒæ•´ç‚¹

1. **æ•°æ®æ¨¡å‹å±‚**ï¼šæ–°å¢7ä¸ªè¡¨ï¼Œæ‰©å±•2ä¸ªè¡¨
2. **ä¸šåŠ¡é€»è¾‘å±‚**ï¼šæ–°å¢10+ä¸ªServiceç±»
3. **APIæ¥å£å±‚**ï¼šæ–°å¢6ä¸ªBlueprintï¼Œ20+ä¸ªAPIç«¯ç‚¹
4. **å‰ç«¯ç»„ä»¶å±‚**ï¼šæ–°å¢3ä¸ªé€šç”¨ç»„ä»¶ï¼Œ10+ä¸ªä¸šåŠ¡ç»„ä»¶
5. **é›†æˆç‚¹**ï¼šå‘è´§å•è¯¦æƒ…é¡µã€ä»˜æ¬¾æ± é¡µé¢ã€å‡­è¯ç®¡ç†é¡µé¢

### 10.3 ä¸šåŠ¡æµç¨‹çº¦æŸï¼ˆé‡è¦ï¼‰

âš ï¸ **æ‰‹å·¥å½•å…¥æµç¨‹**ï¼š

1. **ç‰©æµæœåŠ¡æ·»åŠ é˜¶æ®µ**ï¼ˆè·Ÿå•ç»„ï¼‰
   - åœ¨å‘è´§å•è¯¦æƒ…é¡µ"ç‰©æµæœåŠ¡"Tabæ‰‹å·¥æ·»åŠ æœåŠ¡å•†
   - æ‰‹å·¥å¡«å†™æœåŠ¡ç±»å‹ã€é¢„ä¼°è´¹ç”¨
   - ä¸Šä¼ æœåŠ¡å‡­è¯ï¼ˆè¿å•ã€æå•ã€æ¸…å…³å•ç­‰ï¼‰

2. **è´¹ç”¨ç¡®è®¤é˜¶æ®µ**ï¼ˆè´¢åŠ¡ç»„ï¼‰
   - æ”¶åˆ°æœåŠ¡å•†è´¦å•åï¼Œæ‰‹å·¥å½•å…¥å®é™…è´¹ç”¨
   - ä¸Šä¼ ä»˜æ¬¾å‡­è¯
   - æ ¸å¯¹æ— è¯¯åï¼Œå°†æœåŠ¡çŠ¶æ€æ ‡è®°ä¸º"å·²ç¡®è®¤"

3. **å¯¹è´¦å•ç”Ÿæˆé˜¶æ®µ**ï¼ˆè´¢åŠ¡ç»„ï¼‰
   - ç³»ç»Ÿä»å·²ç¡®è®¤çš„ç‰©æµæœåŠ¡ç”Ÿæˆå¯¹è´¦å•è‰ç¨¿
   - è´¢åŠ¡äººå‘˜æ‰‹å·¥æ ¸å¯¹é‡‘é¢ï¼Œç¡®è®¤å¯¹è´¦å•
   - ç”Ÿæˆä»˜æ¬¾å•ï¼Œè¿›å…¥ä»˜æ¬¾æ± 

4. **æ— è‡ªåŠ¨å¯¹è´¦**
   - ä¸æ¶‰åŠAPIè‡ªåŠ¨æ‹‰å–è´¹ç”¨
   - ä¸æ¶‰åŠè‡ªåŠ¨å¯¹è´¦é€»è¾‘
   - æ‰€æœ‰é‡‘é¢ä¾èµ–äººå·¥å½•å…¥å’Œç¡®è®¤

### 10.4 æš‚ç¼“åŠŸèƒ½åˆ—è¡¨

ä»¥ä¸‹åŠŸèƒ½**æš‚ä¸å®æ–½**ï¼Œå¾…ç‰©æµæœåŠ¡å•†æä¾›APIåå†æ‰©å±•ï¼š

| åŠŸèƒ½ | åŸå›  | æœªæ¥æ‰©å±•æ¡ä»¶ |
|------|------|------------|
| â¸ï¸ è‡ªåŠ¨å¯¹æ¥ç‰©æµæœåŠ¡å•†API | æœåŠ¡å•†æ— API | æœåŠ¡å•†æä¾›æ ‡å‡†API |
| â¸ï¸ è‡ªåŠ¨è·å–è´¹ç”¨ | æ— æ•°æ®æº | APIæä¾›è´¹ç”¨æŸ¥è¯¢æ¥å£ |
| â¸ï¸ è‡ªåŠ¨å¯¹è´¦ | éœ€è¦APIæ”¯æŒ | APIæä¾›è´¦å•æ•°æ® |
| â¸ï¸ è´¹ç”¨è‡ªåŠ¨æ ¡éªŒ | æ— æ ‡å‡†æ•°æ® | å»ºç«‹è´¹ç”¨åŸºå‡†åº“ |

### 10.5 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **ç¡®è®¤æœ¬æ¸…å•** - è¯„ä¼°å·¥ä½œé‡å’Œä¼˜å…ˆçº§
2. ğŸ“ **å¯åŠ¨é˜¶æ®µ0** - æ’°å†™3ä»½è¯¦ç»†è®¾è®¡æ–‡æ¡£
3. ğŸ› ï¸ **å¯åŠ¨é˜¶æ®µ1** - å¼€å§‹æ•°æ®åº“è¿ç§»å’ŒåŸºç¡€æ¨¡å‹å¼€å‘
4. ğŸ”„ **æŒç»­è¿­ä»£** - æŒ‰6ä¸ªé˜¶æ®µé€æ­¥æ¨è¿›

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å¾…ç¡®è®¤  
**ç¡®è®¤äºº**: [å¾…å¡«å†™]  
**ç¡®è®¤æ—¥æœŸ**: [å¾…å¡«å†™]

# 2025-11-23 角色权限系统与前端重构

## 1. 概要
本次开发集中于完善系统的核心权限管理模块（RBAC、数据权限、字段权限），并对前端代码进行了深度的组件化重构，解决了代码耦合高、维护难的问题。同时，在后端实现了字段级权限的自动拦截逻辑，确保了数据安全性。

## 2. 核心功能开发

### 2.1 字段权限系统 (Field Permission / Column-Level Security)
- **目标**: 实现对敏感字段（如“采购成本”、“供应商”）的可见性控制。
- **后端实现**:
  - **数据库模型**: 新增 `FieldPermissionMeta` (元数据) 和 `RoleFieldPermission` (配置) 表。
  - **核心拦截器 (`FieldPermissionMixin`)**:
    - 基于 Marshmallow Schema 的 `post_dump` 钩子。
    - 实现了**AOP 切面拦截**，无需修改业务 Service 层代码。
    - 支持**静态权限**（可见/隐藏）和**动态权限**（如“仅跟进人可见”）。
    - 实现了请求级缓存 (`flask.g`)，避免 N+1 查询性能问题。
  - **应用**: 在 `ProductSchema` 中标记了 `cost_price` 等字段，验证了拦截逻辑。
- **前端实现**:
  - 在角色管理页面新增“字段权限” Tab。
  - 实现了基于表格的配置界面，支持“可见”、“不可见”、“仅跟进人可见”三种状态的单选配置。

### 2.2 数据权限系统优化 (Data Permission)
- **目标**: 解决数据权限保存时的性能和原子性问题。
- **改进**:
  - **后端**: 新增批量保存接口 `POST /roles/{id}/data-permissions/bulk`，在一个数据库事务中保存所有配置。
  - **前端**: `DataPermTable` 组件对接新接口，将原来的 N 次并发请求合并为 1 次请求，消除了网络风暴风险。

## 3. 架构重构与优化

### 3.1 前端组件化重构 (Frontend Refactoring)
- **背景**: `role/index.vue` 文件膨胀至 1100+ 行，逻辑严重耦合。
- **行动**: 将上帝组件拆分为 6 个独立子组件：
  - `RoleList.vue`: 左侧角色列表。
  - `RoleUserTable.vue`: 角色用户管理。
  - `FunctionalPermTable.vue`: 功能权限树。
  - `DataPermTable.vue`: 数据权限配置。
  - `FieldPermTable.vue`: 字段权限配置。
  - `RoleUpsertModal.vue`: 角色增改弹窗。
- **结果**: 主入口文件缩减至 ~200 行，仅负责布局和状态分发，代码可维护性显著提升。

### 3.2 用户体验升级 (UX Polish)
- **未保存拦截**: 实现了脏状态检测 (`isDirty`)，在用户切换角色或离开时弹出确认框，防止误操作导致配置丢失。
- **加载反馈**: 引入了 Ant Design 的 `<Skeleton />` 骨架屏，优化了数据加载时的视觉体验。

## 4. 数据库变更
- 新增表: `field_permission_metas`, `role_field_permissions`
- 数据初始化: `seed-db` 命令更新，自动预置了常用的敏感字段元数据。

## 5. 下一步计划
- 将 `FieldPermissionMixin` 推广应用到更多业务模块的 Schema 中。
- 完善前端 `useTablePermission` Hook，实现动态列隐藏（进阶方案）。


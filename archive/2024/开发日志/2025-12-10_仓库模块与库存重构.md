# 仓库管理模块开发与库存模型重构

**日期**: 2025-12-10
**作者**: 技术团队
**版本**: v1.0 (Warehouse Phase 1)

## 1. 开发背景
为了支撑跨境电商复杂的供应链业务，需要构建一套支持多形态（实体/虚拟）、多区域（国内/海外）及多模式（自营/三方）的仓库管理系统。本阶段重点在于搭建后端基础架构、实现核心库存模型，并处理与现有产品中心的对接。

## 2. 核心工作内容

### 2.1 数据模型设计与重构
- **Warehouse (仓库模型)**:
  - 实现了 `physical` (实体) 与 `virtual` (虚拟) 的形态区分。
  - 增加了 `location_type` (domestic/overseas) 和 `ownership_type` (self/third_party) 维度。
  - 支持 `api_config` JSONB 字段以扩展第三方 API 配置。
- **WarehouseLocation (库位模型)**:
  - 新增库位管理，支持 `code`, `type` (storage/pick/receive) 及 `is_locked` 状态。
- **Stock (库存模型重构)**:
  - **重要变更**: 将原计划的 `Stock` 表重命名为 `WarehouseStock` (`warehouse_stocks`)，以避免与未来可能引入的金融或通用 Stock 概念冲突。
  - 字段包含 `physical_quantity`, `available_quantity`, `allocated_quantity` 等核心状态。
  - 引入 `version` 字段实现乐观锁并发控制。
- **WarehouseStockMovement (库存流水)**:
  - 记录所有库存变动（入库、出库、调拨、调整），作为审计和溯源依据。
  - 包含 `order_type`, `order_no`, `quantity_delta` 及成本快照 `unit_cost`。
- **WarehouseStockDiscrepancy (差异记录)**:
  - 新增差异处理表，用于记录第三方仓同步时的库存差异，支持后续的平账处理。
- **WarehouseThirdParty (三方服务重构)** (v1.3-v1.9 新增):
  - **WarehouseThirdPartyService**: 存储服务商认证信息 (AppKey/Secret)。
  - **WarehouseThirdPartyWarehouse**: 存储远程子仓库列表，支持启用/禁用状态，并自动关联本地 `warehouses` 表。
  - **WarehouseThirdPartyProduct**: 新增商品源数据表，作为三方 SKU 的镜像，解决配对时的“未配对”发现问题。
  - **WarehouseThirdPartySkuMapping**: 实现多级 SKU 映射（Level 2 服务商级 / Level 3 仓库级），并优化了关联查询。

### 2.2 业务逻辑实现 (Services)
- **WarehouseService**:
  - 实现了仓库与库位的 CRUD 操作。
  - 增加了删除前的依赖检查（如存在库存则禁止删除仓库）。
- **StockService**:
  - 实现了库存查询、调整及流水记录。
  - **核心逻辑**: `adjust_stock` 方法统一处理库存变动，自动维护 `WarehouseStock` 的数量并生成 `WarehouseStockMovement`，同时校验乐观锁版本。
  - 实现了 `allocate_stock` 和 `release_stock` 用于支持预占逻辑。
- **SyncService (同步服务)**:
  - 实现了第三方仓库存同步的框架逻辑。
  - 包含 `mock_fetch` 模拟外部 API 调用。
  - 实现了差异发现 (`_record_discrepancy`) 与差异解决 (`resolve_discrepancy`) 流程（生成调整单或忽略）。
- **VirtualService (虚拟仓服务)**:
  - 初步实现了基于策略 (`StockAllocationPolicy`) 的虚拟库存计算逻辑。

### 2.3 API 接口开发
- 基于 `MethodView` 实现了全套 RESTful API：
  - `/warehouses`: 仓库管理
  - `/warehouses/{id}/locations`: 库位管理
  - `/stocks`: 库存查询与流水
  - `/stocks/adjust`: 库存调整
  - `/stocks/summary`: 库存汇总
  - `/sync/discrepancies`: 差异处理
  - `/third-party/*`: 三方服务管理（含授权、子仓同步、SKU 配对、商品源同步）。

### 2.4 数据初始化与测试
- **Seed Command (`seed-warehouse`)**:
  - 编写了强大的模拟数据生成脚本，支持 `--clear` 参数。
  - 生成了 7 个典型仓库（国内总仓、美国谷仓、FBA、虚拟销售仓等）。
  - 生成了数百条 SKU 的随机库存余额与历史流水（模拟了入库、销售出库、跨国调拨场景）。
  - 生成了库存差异数据以测试同步流程。
  - **新增**: 生成了三方服务商、子仓库、商品源数据 (`WarehouseThirdPartyProduct`) 及 SKU 映射规则 (`WarehouseThirdPartySkuMapping`)。
- **自动化测试**:
  - 新增 `tests/api/warehouse/test_warehouse.py` 覆盖基础 CRUD。

## 3. 技术债务与后续计划
- **Schema 命名**: API 层仍沿用 `StockSchema` 等名称，虽底层模型已更名为 `WarehouseStock`，但这符合 API 简洁性原则，暂不视为问题。
- **前端对接**:
  - 已完成三方服务管理前端（列表、详情页、子仓启用、SKU 配对）。
  - 下一步需开发通用库存查询与差异处理页面。
- **真实 API 对接**: `SyncService` 目前使用 Mock 数据，后续需对接真实的谷仓/万邑通 API。

## 4. 数据库变更记录
- `Rev: 6098d8fb0854`: Rename stock tables to warehouse_stocks
- `Rev: 722e2ca5176b`: Add warehouse models
- `Rev: c4041798fdfe`: Rename third_party tables to warehouse_prefix
- `Rev: (New)`: Add warehouse_third_party_products table

# 2025-12-08 产品创建重构与双轨制落地

## 1. 核心变更：双轨制编码体系 (Dual-Track Coding)

本次更新完成了产品编码体系的重大重构，实现了 "SPU Feature Code" (业务特征码) 与 "System SKU" (系统短码) 的双轨并行。

- **后端驱动 (SSOT)**: 废弃前端编码生成逻辑，全面接入 `CodeBuilderService`。前端通过 `/products/aux/preview` 实时预览编码，确保前后端逻辑强一致。
- **SKU Serial 复用 (Upsert)**: 解决了“向现有 SPU 添加新变体”时的流水号跳变问题。系统现在会智能检测已有 SPU 的基础 Serial（如 `01`），并强制新变体复用该 Serial，仅递增后缀。
- **属性配置驱动**: 严格遵循属性字典中的 `attribute_scope` (SPU/SKU) 和 `include_in_code` (True/False) 配置，精确控制编码生成规则（如位置属性生成 `P/D` 后缀，颜色属性生成 `BK/CH` 后缀）。

## 2. 用户体验优化 (UX/UI)

### 2.1 车型选择器重构 (VehicleCascader)
- **分级异步加载**: 解决了 5MB+ 全量车型树导致的页面卡顿和超时问题。
  - Level 1: Brands (kb级，秒开)
  - Level 2: Models (按需加载)
  - Level 3: Years (按需加载)
- **智能联动**: 用户选中 Model 层级时，自动拉取 Years 数据并计算 `Start-End` 年份区间，回填至 SPU 参数。

### 2.2 增量创建模式 (Incremental Creation)
- **已有变体加载**: 支持通过 SPU Code 反查并加载已有变体。
- **智能合并 (Smart Merge)**: 
  - 自动锁定已存在的 SKU 行（不可删除/修改）。
  - 新生成的变体自动与已有列表比对，跳过重复项，仅追加新组合。
- **公共属性锁定**: 加载已有 SPU 时，自动回显并锁定公共属性（如材质、系列），防止数据冲突。

### 2.3 结果反馈
- **详细统计 Modal**: 创建成功后弹出富文本提示，展示 "新增 X 个，更新 Y 个，忽略 Z 个"，并列出新生成的 SKU 列表。
- **手动重置**: 提交成功后保留表单状态，方便用户继续进行“微调+新增”操作。

## 3. 后端架构更新

### 3.1 API 变更
- **新增**: `/v1/vehicles/brands`, `/v1/vehicles/brands/{id}/models`, `/v1/vehicles/models/{id}/years` (支持分级加载)。
- **更新**: `POST /v1/products` 返回值结构升级，包含 `action` (created/merged) 和 `stats` (统计信息)。
- **新增**: `POST /v1/products/aux/preview` 用于实时编码预览。

### 3.2 服务层逻辑
- **Upsert Logic**: `ProductService.create_product` 现在支持幂等操作。如果 SPU 已存在，自动转为 "Merge" 模式，仅新增不存在的 SKU。
- **原子性保障**: 引入 SKU 碰撞检测 (409 Conflict) 和 SPU 重复预警业务码 (30003)。

## 4. 下一步计划
- **批量导入**: 基于 Excel 的产品导入功能，复用当前的 `CodeBuilder` 逻辑。
- **属性管理优化**: 提供更直观的属性字典配置界面，方便调整 `include_in_code` 规则。


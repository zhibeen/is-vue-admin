# 2025-11-30 供应链财务增强与并发控制

## 1. 概要
本次开发迭代（P0 级）聚焦于供应链模块的**财务合规性**、**数据一致性**以及**系统稳定性**。我们通过引入数据快照机制解决了历史数据回溯问题，通过乐观锁解决了并发修改冲突，并深度定制了 Excel/PDF 报表以满足财务与供应链的实际业务需求。此外，还解决了后端架构中的包命名冲突问题。

## 2. 核心功能开发

### 2.1 供应链财务增强 (Supply Chain Financials)
- **数据快照 (Data Snapshot)**:
  - **背景**: 供应商主数据变更（如改名）导致历史合同信息失真。
  - **实现**: 在 `ScmDeliveryContract` 表新增 `supplier_snapshot` (JSONB) 字段。在合同创建/更新时，自动固化当前的供应商名称、税号、银行账号等关键信息。
  - **价值**: 确保历史单据永久可追溯，不仅是引用 ID。

- **Excel 报表深度定制**:
  - **背景**: 前端导出无法满足多 Sheet、合并单元格及财务计算需求。
  - **实现**: 
    - 引入 `openpyxl` 库，开发 `ExcelService`。
    - **分 Sheet**: 按“采购主体”自动分组创建 Sheet。
    - **合并单元格**: 自动合并同一合同下的公共信息列。
    - **财务列**: 新增“已付金额”、“未付余额”自动计算列。
    - **币种汇总**: 报表底部增加按币种的金额总计。
  - **前端**: 重构导出交互，使用自定义 Modal 替代 VxeTable 原生弹窗，支持“默认选中/全量”智能切换。

- **单据合规性 (Compliance)**:
  - **实现**: 优化 PDF 模板，底部新增标准的“送货方/收货方/质检”签字栏。
  - **价值**: 打印出的 PDF 可直接作为线下入库交接的法律凭证。

### 2.2 并发与审计 (Concurrency & Audit)
- **乐观锁 (Optimistic Locking)**:
  - **痛点**: 多人同时修改同一合同可能导致资金数据覆盖。
  - **实现**: 
    - 在 `ScmDeliveryContract` 增加 `version` 字段。
    - `SupplyService.update_contract` 强制检查版本号，冲突时抛出 `StaleDataError`。
  - **测试**: 编写了单元测试覆盖版本冲突与正常更新场景。

- **变更日志 (Change Log)**:
  - **实现**: 新增 `ScmContractChangeLog` 表，记录每次变更前后的数据快照 (JSONB)。
  - **价值**: 提供完整的审计轨迹。

## 3. 架构与工程优化

### 3.1 命名空间重构
- **问题**: `app.schemas.purchase` 文件与 `app.schemas.purchase` 目录共存导致 `ImportError`。
- **解决**: 将 `purchase.py`, `product.py`, `category.py` 等单文件迁移至对应的包目录下 (`purchase/supplier.py` 等)，并清理了遗留文件，规范了 Python 包结构。

### 3.2 Docker 环境修复
- **问题**: `pytest` 运行时找不到 `app` 模块。
- **解决**: 在 `Dockerfile` 中添加 `ENV PYTHONPATH=/app`，彻底解决路径解析问题。

### 3.3 前端体验
- **Select 组件优化**: 全局为搜索表单的 Select 组件添加 `allowClear`，提升操作便捷性。
- **列表页优化**: 调整列宽策略 (`minWidth`)，防止长文本截断。

## 4. 数据库变更
- **新增表**: `scm_contract_change_logs`
- **新增字段**: `scm_delivery_contracts.supplier_snapshot`, `scm_delivery_contracts.version`
- **迁移**: `f21f83573982` -> `47dea84e5d23`

## 5. 下一步计划
- **L2 资金结算**: 既然 L1 基础已夯实，下一步将启动 `FinPurchaseSOA` (L2 结算单) 的开发，实现多合同合并付款申请。
- **前端适配**: 在前端详情页对接“变更历史”展示和“版本号”提交逻辑。


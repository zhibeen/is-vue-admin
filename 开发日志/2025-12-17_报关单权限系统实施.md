# 2025-12-17 æŠ¥å…³å•æƒé™ç³»ç»Ÿå®æ–½

## 1. é—®é¢˜èƒŒæ™¯

åœ¨å®æ–½æŠ¥å…³å•ç³»ç»Ÿçš„ç”Ÿäº§å°±ç»ªæ”¹è¿›æ—¶ï¼Œä¸ºAPIæ·»åŠ äº†`@permission_required`è£…é¥°å™¨è¿›è¡Œæƒé™æ§åˆ¶ï¼Œä½†ç³»ç»Ÿä¸­ç¼ºå°‘å¯¹åº”çš„æƒé™åˆå§‹åŒ–ï¼Œå¯¼è‡´å³ä½¿adminç”¨æˆ·ä¹Ÿæ— æ³•è®¿é—®æŠ¥å…³å•åŠŸèƒ½ã€‚

## 2. å®æ–½å†…å®¹

### 2.1 åˆ›å»ºæƒé™ç®¡ç†å‘½ä»¤æ¨¡å—

**æ–°å¢æ–‡ä»¶**: `backend/app/commands/permissions.py`

- å®ç° `seed-permissions` å‘½ä»¤
- å®šä¹‰äº†å®Œæ•´çš„æƒé™ä½“ç³»ï¼š
  - ç³»ç»Ÿç®¡ç†æ¨¡å—ï¼ˆ5ä¸ªæƒé™ï¼‰
  - å•†å“ä¸­å¿ƒæ¨¡å—ï¼ˆ5ä¸ªæƒé™ï¼‰
  - å…³åŠ¡ç®¡ç†æ¨¡å—ï¼ˆ10ä¸ªæƒé™ï¼‰
- è‡ªåŠ¨å°†æ‰€æœ‰æƒé™åˆ†é…ç»™ admin è§’è‰²

### 2.2 æƒé™ä½“ç³»è®¾è®¡

#### å…³åŠ¡æ¨¡å—æƒé™æ¸…å•

| æƒé™ä»£ç  | æ¨¡å— | èµ„æº | æ“ä½œ | è¯´æ˜ |
|---------|------|------|------|------|
| `customs:view` | å…³åŠ¡ç®¡ç† | æŠ¥å…³å•ç®¡ç† | view | æŸ¥çœ‹æŠ¥å…³å• |
| `customs:create` | å…³åŠ¡ç®¡ç† | æŠ¥å…³å•ç®¡ç† | create | åˆ›å»ºæŠ¥å…³å• |
| `customs:edit` | å…³åŠ¡ç®¡ç† | æŠ¥å…³å•ç®¡ç† | update | ç¼–è¾‘æŠ¥å…³å• |
| `customs:delete` | å…³åŠ¡ç®¡ç† | æŠ¥å…³å•ç®¡ç† | delete | åˆ é™¤æŠ¥å…³å• |
| `customs:approve` | å…³åŠ¡ç®¡ç† | æŠ¥å…³å•ç®¡ç† | approve | å®¡æ‰¹æŠ¥å…³å• |
| `customs:export` | å…³åŠ¡ç®¡ç† | æŠ¥å…³å•ç®¡ç† | export | å¯¼å‡ºæŠ¥å…³å• |
| `customs:product:view` | å…³åŠ¡ç®¡ç† | å½’ç±»å•†å“åº“ | view | æŸ¥çœ‹æŠ¥å…³å“ç±» |
| `customs:product:manage` | å…³åŠ¡ç®¡ç† | å½’ç±»å•†å“åº“ | manage | ç®¡ç†æŠ¥å…³å“ç±» |
| `customs:consignee:view` | å…³åŠ¡ç®¡ç† | å¢ƒå¤–æ”¶è´§äºº | view | æŸ¥çœ‹æ”¶è´§äºº |
| `customs:consignee:manage` | å…³åŠ¡ç®¡ç† | å¢ƒå¤–æ”¶è´§äºº | manage | ç®¡ç†æ”¶è´§äºº |

### 2.3 å‘½ä»¤æ³¨å†Œ

**ä¿®æ”¹æ–‡ä»¶**:
- `backend/app/commands/__init__.py`: æ³¨å†Œ `permissions_cli` å‘½ä»¤ç»„
- `backend/app/commands/core.py`: åœ¨ `init-dev` æµç¨‹ä¸­é›†æˆæƒé™åˆå§‹åŒ–

### 2.4 é›†æˆåˆ°å¼€å‘ç¯å¢ƒåˆå§‹åŒ–æµç¨‹

æ›´æ–°åçš„ `flask core init-dev` æµç¨‹ï¼š

```
[1/6] åˆå§‹åŒ–ç”¨æˆ·ä¸è§’è‰²
[2/6] åˆå§‹åŒ–ç³»ç»Ÿæƒé™ â† æ–°å¢
[3/6] åˆå§‹åŒ–ç³»ç»Ÿå­—å…¸ä¸é…ç½®
[4/6] åˆå§‹åŒ–å†…éƒ¨å…¬å¸ä¸»ä½“
[5/6] åˆå§‹åŒ–äº§å“åˆ†ç±»ä¸å±æ€§
[6/6] åˆå§‹åŒ–è½¦å‹æ ‡å‡†åº“
```

## 3. æ‰§è¡Œç»“æœ

### 3.1 æƒé™åˆå§‹åŒ–

```bash
$ docker compose exec backend flask permissions seed-permissions
âœ… æƒé™åˆå§‹åŒ–å®Œæˆï¼æ–°å¢ 20 ä¸ªæƒé™
âœ… å·²å°† 20 ä¸ªæƒé™åˆ†é…ç»™ admin è§’è‰²
```

### 3.2 éªŒè¯ç»“æœ

```
âœ… æ‰¾åˆ°ç”¨æˆ·: admin
   è§’è‰²: ['admin']
   æ€»æƒé™æ•°: 20

ğŸ“‹ å…³åŠ¡æ¨¡å—æƒé™ (10ä¸ª):
   âœ“ customs:approve
   âœ“ customs:consignee:manage
   âœ“ customs:consignee:view
   âœ“ customs:create
   âœ“ customs:delete
   âœ“ customs:edit
   âœ“ customs:export
   âœ“ customs:product:manage
   âœ“ customs:product:view
   âœ“ customs:view

âœ… æ‰€æœ‰å¿…éœ€çš„å…³åŠ¡æƒé™å·²åˆ†é…ï¼
```

## 4. æƒé™æµè½¬æœºåˆ¶

### 4.1 åç«¯æƒé™æ§åˆ¶

```python
from app.decorators import permission_required

@customs_bp.route('/declarations')
class DeclarationListAPI(MethodView):
    @permission_required('customs:view')
    def get(self, query):
        # ...
    
    @permission_required('customs:create')
    def post(self, data):
        # ...
```

### 4.2 JWT Claims ç»“æ„

ç™»å½•æ—¶ï¼Œç”¨æˆ·çš„è§’è‰²å’Œæƒé™è¢«å†™å…¥ JWT:

```json
{
  "roles": ["admin"],
  "permissions": [
    "system:view",
    "product:view",
    "customs:view",
    "customs:create",
    ...
  ]
}
```

### 4.3 è£…é¥°å™¨éªŒè¯é€»è¾‘

`@permission_required` è£…é¥°å™¨ï¼ˆ`backend/app/decorators.py`ï¼‰ï¼š
1. ä» JWT claims ä¸­æå– `permissions` åˆ—è¡¨
2. æ£€æŸ¥æ˜¯å¦åŒ…å«æ‰€éœ€æƒé™
3. å¦‚æœç”¨æˆ·è§’è‰²ä¸º `admin`ï¼Œè‡ªåŠ¨æ”¾è¡Œï¼ˆè¶…çº§ç®¡ç†å‘˜ç»•è¿‡ï¼‰
4. å¦åˆ™è¿”å› 403 Forbidden

## 5. ä½¿ç”¨è¯´æ˜

### 5.1 å‘½ä»¤è¡Œå·¥å…·

```bash
# åˆå§‹åŒ–æƒé™ï¼ˆå•ç‹¬æ‰§è¡Œï¼‰
docker compose exec backend flask permissions seed-permissions

# æ¸…ç©ºå¹¶é‡æ–°åˆå§‹åŒ–
docker compose exec backend flask permissions seed-permissions --clear

# å®Œæ•´å¼€å‘ç¯å¢ƒåˆå§‹åŒ–ï¼ˆåŒ…å«æƒé™ï¼‰
docker compose exec backend flask core init-dev --reset
```

### 5.2 å‰ç«¯ä½¿ç”¨

**é‡è¦**: ç”¨æˆ·éœ€è¦**é‡æ–°ç™»å½•**ä»¥è·å–åŒ…å«æ–°æƒé™çš„ JWT tokenã€‚

å‰ç«¯å¯ä»¥ä½¿ç”¨æƒé™æŒ‡ä»¤æ§åˆ¶æŒ‰é’®/åŠŸèƒ½å¯è§æ€§ï¼š

```vue
<template>
  <a-button v-auth="'customs:create'" @click="handleCreate">
    æ–°å»ºæŠ¥å…³å•
  </a-button>
</template>
```

## 6. ä¸‹ä¸€æ­¥è®¡åˆ’

### 6.1 è§’è‰²ç²¾ç»†åŒ–

å½“å‰ admin è§’è‰²æ‹¥æœ‰æ‰€æœ‰æƒé™ã€‚åç»­å¯ä»¥åˆ›å»ºæ›´ç»†ç²’åº¦çš„è§’è‰²ï¼š

- **æŠ¥å…³ä¸“å‘˜**: ä»… `customs:view`, `customs:create`, `customs:edit`
- **æŠ¥å…³ä¸»ç®¡**: å¢åŠ  `customs:approve` å®¡æ‰¹æƒé™
- **æ•°æ®ç®¡ç†å‘˜**: å¢åŠ  `customs:product:manage`, `customs:consignee:manage`

### 6.2 æ•°æ®æƒé™é›†æˆ

ç»“åˆç°æœ‰çš„æ•°æ®æƒé™ç³»ç»Ÿï¼ˆ`DataPermissionMeta`ï¼‰ï¼Œå¯ä»¥è¿›ä¸€æ­¥é™åˆ¶ç”¨æˆ·åªèƒ½çœ‹åˆ°ç‰¹å®šå…¬å¸çš„æŠ¥å…³å•ã€‚

### 6.3 å‰ç«¯æƒé™æ ‘å±•ç¤º

åœ¨è§’è‰²ç®¡ç†é¡µé¢çš„"åŠŸèƒ½æƒé™" Tab ä¸­ï¼Œå…³åŠ¡æ¨¡å—çš„æƒé™åº”è¯¥è‡ªåŠ¨æ˜¾ç¤ºåœ¨æƒé™æ ‘ä¸­ï¼Œç®¡ç†å‘˜å¯ä»¥çµæ´»åˆ†é…ç»™ä¸åŒè§’è‰²ã€‚

## 7. æŠ€æœ¯è¦ç‚¹

### 7.1 æƒé™å‘½åè§„èŒƒ

```
{module}:{resource}:{action}
```

- æ¨¡å—çº§æƒé™: `customs:view`
- èµ„æºçº§æƒé™: `customs:product:manage`

### 7.2 æƒé™ä¸æ•°æ®åº“ç»“æ„

```
User (ç”¨æˆ·)
  â”œâ”€ roles (M:N) â†’ Role (è§’è‰²)
  â”‚    â””â”€ permissions (M:N) â†’ Permission (æƒé™)
  â””â”€ @property permissions: èšåˆæ‰€æœ‰è§’è‰²çš„æƒé™é›†åˆ
```

### 7.3 Admin è§’è‰²ç‰¹æƒ

åœ¨ `permission_required` è£…é¥°å™¨ä¸­ï¼Œ`admin` è§’è‰²è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼Œæ— éœ€åœ¨æ•°æ®åº“ä¸­æ˜ç¡®åˆ†é…ã€‚è¿™æ˜¯ä¸€ä¸ªå®‰å…¨çš„è®¾è®¡ï¼Œç¡®ä¿è¶…çº§ç®¡ç†å‘˜ä¸ä¼šè¢«é”åœ¨ç³»ç»Ÿå¤–ã€‚

## 8. æ•…éšœæ’æŸ¥

### 8.1 å‰ç«¯æ˜¾ç¤º 403 Forbidden

**åŸå› **: JWT token ä¸­ä¸åŒ…å«æ‰€éœ€æƒé™

**è§£å†³**:
1. ç¡®ä¿æƒé™å·²åˆå§‹åŒ–: `flask permissions seed-permissions`
2. ç¡®ä¿ç”¨æˆ·è§’è‰²å·²åˆ†é…æƒé™
3. **ç”¨æˆ·é‡æ–°ç™»å½•**è·å–æ–° token

### 8.2 æƒé™ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥æ¸…å•**:
```bash
# 1. æ£€æŸ¥æƒé™æ˜¯å¦å­˜åœ¨
docker compose exec backend flask shell
>>> from app.models.user import Permission
>>> Permission.query.filter_by(name='customs:view').first()

# 2. æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰æƒé™
>>> from app.models.user import Role
>>> admin_role = Role.query.filter_by(name='admin').first()
>>> print([p.name for p in admin_role.permissions])

# 3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è§’è‰²
>>> from app.models.user import User
>>> admin = User.query.filter_by(username='admin').first()
>>> print(admin.role_names)
>>> print(list(admin.permissions))
```

## 9. æ€»ç»“

æœ¬æ¬¡å®æ–½å®Œå–„äº†æŠ¥å…³å•ç³»ç»Ÿçš„æƒé™æ§åˆ¶ä½“ç³»ï¼Œä½¿å¾—ï¼š

1. âœ… **å®‰å…¨æ€§**: æ‰€æœ‰æ•æ„Ÿæ“ä½œéƒ½å—æƒé™ä¿æŠ¤
2. âœ… **å¯ç®¡ç†æ€§**: é€šè¿‡å‘½ä»¤è¡Œå·¥å…·å¿«é€Ÿåˆå§‹åŒ–æƒé™
3. âœ… **å¯æ‰©å±•æ€§**: æƒé™ä½“ç³»ç»“æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•æ–°æ¨¡å—
4. âœ… **é›†æˆæ€§**: ä¸ç°æœ‰ RBAC ç³»ç»Ÿæ— ç¼é›†æˆ
5. âœ… **ç”¨æˆ·å‹å¥½**: è‡ªåŠ¨åŒ–åˆ†é…ï¼Œé™ä½é…ç½®æˆæœ¬

ç³»ç»Ÿç°å·²å…·å¤‡ç”Ÿäº§ç¯å¢ƒæ‰€éœ€çš„åŸºæœ¬æƒé™ç®¡ç†èƒ½åŠ›ã€‚

